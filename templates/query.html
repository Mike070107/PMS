<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•æŸ¥è¯¢ - ç‰©ä¸šæ”¶è´¹ç®¡ç†ç³»ç»Ÿ</title>
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.3.14/dist/index.css">
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus@2.3.14/dist/index.full.js"></script>
    <!-- Axios -->
    <script src="https://unpkg.com/axios@1.4.0/dist/axios.min.js"></script>
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Flatpickr Chinese locale -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
        }

        /* å·¦ä¾§å¯¼èˆªæ  */
        .sidebar {
            width: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .sidebar-title {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .sidebar-user {
            text-align: center;
            font-size: 14px;
            opacity: 0.9;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border-left-color: #ffd700;
        }

        .nav-icon {
            margin-right: 10px;
            font-size: 16px;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            margin-left: 200px;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
            font-size: 14px;
        }

        /* è®¢å•æŸ¥è¯¢å®¹å™¨ */
        .order-query-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        /* ç­›é€‰æ¡ä»¶åŒºåŸŸ */
        .filter-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-bottom: 30px;
            padding: 25px;
            background: #fafbfc;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .filter-item {
            display: flex;
            align-items: flex-start;
            gap: 20px;
        }

        .filter-label {
            min-width: 80px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
            padding-top: 8px;
        }

        .date-range-picker {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .date-input-group label {
            font-size: 13px;
            color: #6c757d;
            font-weight: 500;
        }

        .datetime-input {
            width: 220px;
            height: 40px;
            padding: 0 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .datetime-input:hover {
            border-color: #409eff;
        }

        .datetime-input:focus {
            border-color: #409eff;
            box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.1);
            outline: none;
        }

        .date-separator {
            color: #6c757d;
            font-weight: 500;
            padding-top: 20px;
        }

        .address-selector {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .filter-actions {
            display: flex;
            gap: 12px;
        }

        .error-message {
            color: #f56c6c;
            font-size: 12px;
            margin-top: 5px;
            padding-left: 80px;
        }

        /* ç»Ÿè®¡ä¿¡æ¯åŒºåŸŸ */
        .statistics-section {
            padding: 20px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            margin-bottom: 25px;
            color: white;
        }

        .statistics-info {
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .highlight {
            font-weight: bold;
            color: #ffd700;
            font-size: 18px;
        }

        /* ç»“æœå±•ç¤ºåŒºåŸŸ */
        .results-section {
            min-height: 400px;
            position: relative;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            background: #fafbfc;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .custom-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #409eff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            color: #666;
            font-weight: 500;
        }

        /* è¡¨æ ¼å®¹å™¨ */
        .table-container {
            overflow-x: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .orders-table th {
            background: #f8f9fa;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }

        .orders-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s ease;
        }

        .orders-table th.sortable:hover {
            background: #e9ecef;
        }

        .orders-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .odd-row {
            background-color: #ffffff;
        }

        .even-row {
            background-color: #fafbfc;
        }

        .orders-table tbody tr:hover {
            background-color: #f0f8ff;
            transition: background-color 0.3s ease;
        }

        .order-id {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #495057;
        }

        .order-id span {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .order-id span:hover {
            background-color: #e9ecef;
            color: #409eff;
        }

        .copy-icon {
            font-size: 12px;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .order-id span:hover .copy-icon {
            opacity: 1;
        }

        .customer-info {
            min-width: 120px;
        }

        .customer-name {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .customer-phone {
            font-size: 12px;
            color: #6c757d;
        }

        .address {
            font-weight: 500;
            color: #495057;
        }

        .fee-items {
            max-width: 200px;
            line-height: 1.5;
        }

        .fee-item {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            margin: 2px 0;
            display: inline-block;
        }

        .amount {
            font-weight: 600;
            color: #28a745;
            font-size: 15px;
        }

        .status-tag {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-tag.success {
            background: #d4edda;
            color: #155724;
        }

        .date {
            color: #6c757d;
            font-size: 13px;
        }

        .actions {
            min-width: 80px;
        }

        /* ç©ºæ•°æ®çŠ¶æ€ */
        .empty-data, .initial-state {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            background: #fafbfc;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            color: #6c757d;
        }

        .empty-data p, .initial-state p {
            margin-top: 15px;
            font-size: 16px;
        }

        /* åˆ†é¡µç»„ä»¶ */
        .pagination-section {
            display: flex;
            justify-content: center;
            padding: 25px 0;
            background: white;
            border-top: 1px solid #e9ecef;
            margin-top: 25px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                width: 180px;
            }
            
            .main-content {
                margin-left: 180px;
                padding: 15px;
            }
            
            .order-query-container {
                padding: 20px;
            }
            
            .filter-section {
                padding: 20px;
            }
            
            .date-range-picker {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .address-selector {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .filter-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .filter-label {
                min-width: auto;
                padding-top: 0;
            }
            
            .error-message {
                padding-left: 0;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                width: 160px;
            }
            
            .main-content {
                margin-left: 160px;
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .datetime-input {
                width: 180px;
            }
        }

        /* Element Plus æ ·å¼è¦†ç›– */
        .el-select {
            width: 176px;
        }

        .el-button {
            border-radius: 6px;
            font-weight: 500;
        }

        .el-button--primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }

        .el-button--primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .el-pagination {
            justify-content: center;
        }

        /* å¤åˆ¶æˆåŠŸæç¤º */
        .copy-success-tooltip {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 10000;
            pointer-events: none;
            animation: fadeInOut 2s ease-in-out;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="app-container">
            <!-- å·¦ä¾§å¯¼èˆªæ  -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">ç‰©ä¸šæ”¶è´¹ç®¡ç†</div>
                    <div class="sidebar-user">[[ user.name ]]</div>
                </div>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="/" class="nav-link">
                            <i class="nav-icon">ğŸ“Š</i>
                            <span>æ”¶è´¹å·¥ä½œå°</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/query" class="nav-link active">
                            <i class="nav-icon">ğŸ”</i>
                            <span>è®¢å•æŸ¥è¯¢</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" @click="logout">
                            <i class="nav-icon">ğŸšª</i>
                            <span>é€€å‡ºç™»å½•</span>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <div class="main-content">
                <!-- é¡µé¢å¤´éƒ¨ -->
                <div class="header">
                    <div class="header-title">è®¢å•æŸ¥è¯¢</div>
                    <div class="header-actions">
                        <div class="user-info">
                            <span>æ¬¢è¿ï¼Œ[[ user.name ]]</span>
                            <span>|</span>
                            <span>[[ user.communityName ]]</span>
                        </div>
                    </div>
                </div>

                <!-- è®¢å•æŸ¥è¯¢å®¹å™¨ -->
                <div class="order-query-container">
                    <!-- é¡¶éƒ¨ç­›é€‰æ¡ä»¶åŒºåŸŸ -->
                    <div class="filter-section">
                        <!-- æ”¶è´¹æ—¥æœŸé€‰æ‹©ç»„ä»¶ -->
                        <div class="filter-item">
                            <div class="filter-label">æ”¶è´¹æ—¥æœŸ</div>
                            <div class="date-range-picker">
                                <div class="date-input-group">
                                    <label>å¼€å§‹æ—¶é—´</label>
                                    <input 
                                        type="text" 
                                        id="startTime" 
                                        class="datetime-input"
                                        placeholder="è¯·é€‰æ‹©å¼€å§‹æ—¶é—´"
                                        readonly>
                                </div>
                                <span class="date-separator">è‡³</span>
                                <div class="date-input-group">
                                    <label>ç»“æŸæ—¶é—´</label>
                                    <input 
                                        type="text" 
                                        id="endTime" 
                                        class="datetime-input"
                                        placeholder="è¯·é€‰æ‹©ç»“æŸæ—¶é—´"
                                        readonly>
                                </div>
                            </div>
                        </div>
                        
                        <!-- åœ°å€é€‰æ‹©ç»„ä»¶ -->
                        <div class="filter-item">
                            <div class="filter-label">åœ°å€é€‰æ‹©</div>
                            <div class="address-selector">
                                <el-select 
                                    v-model="queryBuilding" 
                                    placeholder="è¯·é€‰æ‹©æ¥¼æ ‹" 
                                    style="width: 176px;"
                                    @change="onQueryBuildingChange"
                                    clearable>
                                    <el-option
                                        v-for="building in queryBuildings"
                                        :key="building"
                                        :label="building"
                                        :value="building">
                                    </el-option>
                                </el-select>
                                <el-select 
                                    v-model="queryRoomId" 
                                    :placeholder="queryBuilding ? 'è¯·é€‰æ‹©æˆ¿é—´' : 'å…ˆé€‰æ¥¼æ ‹'" 
                                    style="width: 176px;"
                                    @change="onQueryRoomChange"
                                    :disabled="!queryBuilding"
                                    clearable>
                                    <el-option
                                        v-for="room in queryRooms"
                                        :key="room.id"
                                        :label="room.room"
                                        :value="room.id">
                                    </el-option>
                                </el-select>
                            </div>
                        </div>
                        
                        <!-- æŸ¥è¯¢æŒ‰é’® -->
                        <div class="filter-item">
                            <div class="filter-label">&nbsp;</div>
                            <div class="filter-actions">
                                <el-button 
                                    type="primary" 
                                    @click="queryOrders"
                                    :loading="queryLoading"
                                    style="width: 96px; height: 36px;">
                                    æŸ¥è¯¢
                                </el-button>
                                <el-button 
                                    @click="resetQuery"
                                    style="width: 96px; height: 36px;">
                                    é‡ç½®
                                </el-button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ•°æ®ç»Ÿè®¡åŒºåŸŸ -->
                    <div class="statistics-section" v-if="queryData.length > 0">
                        <div class="statistics-info">
                            å…± <span class="highlight">[[ queryPagination.total ]]</span> æ¡è®°å½•ï¼Œ
                            åˆè®¡é‡‘é¢ï¼š<span class="highlight">Â¥[[ formatPrice(currentPageTotal) ]]</span>
                        </div>
                    </div>
                    
                    <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
                    <div class="results-section">
                        <!-- åŠ è½½çŠ¶æ€ -->
                        <div v-if="queryLoading" class="loading-container">
                            <div class="custom-loading">
                                <div class="loading-spinner"></div>
                                <div class="loading-text">æ­£åœ¨æŸ¥è¯¢è®¢å•æ•°æ®...</div>
                            </div>
                        </div>
                        
                        <!-- æ•°æ®è¡¨æ ¼ -->
                        <div v-else-if="queryData.length > 0" class="table-container">
                            <table class="orders-table">
                                <thead>
                                    <tr>
                                        <th @click="sortByColumn('orderId')" class="sortable">
                                            è®¢å•å·
                                            <i class="el-icon-sort" v-if="sortColumn !== 'orderId'"></i>
                                            <i class="el-icon-sort-up" v-else-if="sortOrder === 'asc'"></i>
                                            <i class="el-icon-sort-down" v-else></i>
                                        </th>
                                        <th>å®¢æˆ·ä¿¡æ¯</th>
                                        <th>åœ°å€</th>
                                        <th>æ”¶è´¹é¡¹ç›®</th>
                                        <th @click="sortByColumn('totalAmount')" class="sortable">
                                            æ”¶è´¹é‡‘é¢
                                            <i class="el-icon-sort" v-if="sortColumn !== 'totalAmount'"></i>
                                            <i class="el-icon-sort-up" v-else-if="sortOrder === 'asc'"></i>
                                            <i class="el-icon-sort-down" v-else></i>
                                        </th>
                                        <th>æ”¶è´¹çŠ¶æ€</th>
                                        <th @click="sortByColumn('entryTime')" class="sortable">
                                            æ”¶è´¹æ—¥æœŸ
                                            <i class="el-icon-sort" v-if="sortColumn !== 'entryTime'"></i>
                                            <i class="el-icon-sort-up" v-else-if="sortOrder === 'asc'"></i>
                                            <i class="el-icon-sort-down" v-else></i>
                                        </th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(order, index) in queryData" :key="order.orderId" :class="{'odd-row': index % 2 === 0, 'even-row': index % 2 === 1}">
                                        <td class="order-id">
                                            <span @click="copyOrderId(order.orderId)" :title="'ç‚¹å‡»å¤åˆ¶: ' + order.orderId">
                                                [[ order.orderId ]]
                                                <i class="el-icon-copy-document copy-icon"></i>
                                            </span>
                                        </td>
                                        <td class="customer-info">
                                            <div class="customer-name">[[ order.residentName || '-' ]]</div>
                                            <div class="customer-phone">[[ order.residentPhone || '-' ]]</div>
                                        </td>
                                        <td class="address">[[ order.building || '-' ]]-[[ order.room || '-' ]]</td>
                                        <td class="fee-items">
                                            <div v-html="formatFeeItems(order.feeItems)"></div>
                                        </td>
                                        <td class="amount">Â¥[[ formatPrice(order.totalAmount) ]]</td>
                                        <td class="status">
                                            <span class="status-tag success">æˆåŠŸ</span>
                                        </td>
                                        <td class="date">[[ formatDate(order.entryTime) ]]</td>
                                        <td class="actions">
                                            <el-button 
                                                type="text" 
                                                size="small" 
                                                @click="showOrderDetail(order)">
                                                è¯¦æƒ…
                                            </el-button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- ç©ºæ•°æ®çŠ¶æ€ -->
                        <div v-else-if="!queryLoading && hasQueried" class="empty-data">
                            <i class="el-icon-document" style="font-size: 48px; color: #ccc; margin-bottom: 10px;"></i>
                            <p>æš‚æ— ç¬¦åˆæ¡ä»¶çš„è®¢å•æ•°æ®</p>
                        </div>
                        
                        <!-- åˆå§‹çŠ¶æ€ -->
                        <div v-else-if="!hasQueried" class="initial-state">
                            <i class="el-icon-search" style="font-size: 48px; color: #ccc; margin-bottom: 10px;"></i>
                            <p>è¯·è®¾ç½®ç­›é€‰æ¡ä»¶åç‚¹å‡»æŸ¥è¯¢</p>
                        </div>
                    </div>
                    
                    <!-- åˆ†é¡µç»„ä»¶ -->
                    <div class="pagination-section" v-if="queryData.length > 0">
                        <el-pagination
                            @size-change="handleSizeChange"
                            @current-change="handleCurrentChange"
                            :current-page="queryPagination.page"
                            :page-sizes="[5, 10, 20, 50]"
                            :page-size="queryPagination.per_page"
                            layout="total, sizes, prev, pager, next, jumper"
                            :total="queryPagination.total">
                        </el-pagination>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
        const { ElSelect, ElOption, ElButton, ElInput, ElInputNumber, ElMessage, ElMessageBox, ElDatePicker, ElLoading } = ElementPlus;

        // åˆ›å»ºVueåº”ç”¨å®ä¾‹
        const app = createApp({
            compilerOptions: {
                delimiters: ['[[', ']]']
            },
            setup() {
                // ç”¨æˆ·ä¿¡æ¯
                const user = ref(JSON.parse(localStorage.getItem('user')) || {});
                
                // è®¢å•æŸ¥è¯¢ç›¸å…³æ•°æ®
                const queryData = ref([]);
                const queryBuildings = ref([]);
                const queryRooms = ref([]);
                const queryBuilding = ref('');
                const queryRoomId = ref('');
                const queryLoading = ref(false);
                const hasQueried = ref(false);
                const dateError = ref('');
                
                // åˆ†é¡µæ•°æ®
                const queryPagination = ref({
                    page: 1,
                    per_page: 10,
                    total: 0,
                    pages: 0
                });
                
                // æ’åºæ•°æ®
                const sortColumn = ref('entryTime');
                const sortOrder = ref('desc');
                
                // æ—¥æœŸé€‰æ‹©å™¨å®ä¾‹
                let startTimePicker = null;
                let endTimePicker = null;

                // è®¡ç®—å½“å‰é¡µåˆè®¡é‡‘é¢
                const currentPageTotal = computed(() => {
                    return queryData.value.reduce((sum, order) => {
                        return sum + (parseFloat(order.totalAmount) || 0);
                    }, 0);
                });

                // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
                const initDatePickers = () => {
                    nextTick(() => {
                        // å¼€å§‹æ—¶é—´é€‰æ‹©å™¨
                        startTimePicker = flatpickr("#startTime", {
                            locale: "zh",
                            enableTime: true,
                            dateFormat: "Y-m-d H:i",
                            time_24hr: true,
                            minuteIncrement: 1,
                            defaultDate: new Date(new Date().setHours(0, 0, 0, 0)),
                            onChange: function(selectedDates, dateStr) {
                                validateDateRange();
                                if (endTimePicker && selectedDates.length > 0) {
                                    endTimePicker.set('minDate', selectedDates[0]);
                                }
                            }
                        });

                        // ç»“æŸæ—¶é—´é€‰æ‹©å™¨
                        endTimePicker = flatpickr("#endTime", {
                            locale: "zh",
                            enableTime: true,
                            dateFormat: "Y-m-d H:i",
                            time_24hr: true,
                            minuteIncrement: 1,
                            defaultDate: new Date(),
                            onChange: function(selectedDates, dateStr) {
                                validateDateRange();
                                if (startTimePicker && selectedDates.length > 0) {
                                    startTimePicker.set('maxDate', selectedDates[0]);
                                }
                            }
                        });
                    });
                };

                // éªŒè¯æ—¥æœŸèŒƒå›´
                const validateDateRange = () => {
                    const startTime = startTimePicker ? startTimePicker.selectedDates[0] : null;
                    const endTime = endTimePicker ? endTimePicker.selectedDates[0] : null;
                    
                    if (startTime && endTime) {
                        const diffMs = endTime - startTime;
                        const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                        
                        if (diffDays > 90) {
                            dateError.value = 'æ—¥æœŸèŒƒå›´ä¸èƒ½è¶…è¿‡90å¤©';
                            return false;
                        } else if (diffMs < 0) {
                            dateError.value = 'ç»“æŸæ—¶é—´ä¸èƒ½æ—©äºå¼€å§‹æ—¶é—´';
                            return false;
                        } else {
                            dateError.value = '';
                            return true;
                        }
                    }
                    dateError.value = '';
                    return true;
                };

                // åŠ è½½æ¥¼æ ‹åˆ—è¡¨
                const loadQueryBuildings = async () => {
                    try {
                        const token = sessionStorage.getItem('token');
                        const response = await axios.get('/api/addresses?step=buildings', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                        
                        if (response.data.status === 'success') {
                            queryBuildings.value = response.data.data || [];
                        }
                    } catch (error) {
                        console.error('åŠ è½½æ¥¼æ ‹åˆ—è¡¨å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½æ¥¼æ ‹åˆ—è¡¨å¤±è´¥');
                    }
                };

                // æŸ¥è¯¢æ¥¼æ ‹å˜åŒ–æ—¶åŠ è½½æˆ¿é—´
                const onQueryBuildingChange = async (building) => {
                    queryRooms.value = [];
                    queryRoomId.value = '';
                    
                    if (!building) return;
                    
                    try {
                        const token = sessionStorage.getItem('token');
                        const response = await axios.get(`/api/addresses?step=rooms&building=${encodeURIComponent(building)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                        
                        if (response.data.status === 'success') {
                            queryRooms.value = response.data.data || [];
                        }
                    } catch (error) {
                        console.error('åŠ è½½æˆ¿é—´åˆ—è¡¨å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½æˆ¿é—´åˆ—è¡¨å¤±è´¥');
                    }
                };

                // æŸ¥è¯¢æˆ¿é—´å˜åŒ–
                const onQueryRoomChange = (roomId) => {
                    console.log('é€‰æ‹©æˆ¿é—´ID:', roomId);
                };

                // æŸ¥è¯¢è®¢å•
                const queryOrders = async () => {
                    // éªŒè¯æ—¥æœŸèŒƒå›´
                    if (!validateDateRange()) {
                        ElMessage.error(dateError.value);
                        return;
                    }
                    
                    queryLoading.value = true;
                    hasQueried.value = true;
                    
                    try {
                        const token = sessionStorage.getItem('token');
                        const params = {
                            page: queryPagination.value.page,
                            per_page: queryPagination.value.per_page,
                            sort: sortColumn.value,
                            order: sortOrder.value
                        };
                        
                        // æ·»åŠ æ—¶é—´å‚æ•°
                        if (startTimePicker && startTimePicker.selectedDates.length > 0) {
                            params.startTime = startTimePicker.selectedDates[0].toISOString();
                        }
                        if (endTimePicker && endTimePicker.selectedDates.length > 0) {
                            params.endTime = endTimePicker.selectedDates[0].toISOString();
                        }
                        
                        // æ·»åŠ åœ°å€å‚æ•°
                        if (queryBuilding.value) {
                            const selectedBuilding = queryBuildings.value.find(b => b === queryBuilding.value);
                            if (selectedBuilding) {
                                params.buildingId = selectedBuilding;
                            }
                        }
                        if (queryRoomId.value) {
                            params.roomId = queryRoomId.value;
                        }
                        
                        const response = await axios.get('/api/orders', {
                    params: params,
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                        
                        if (response.data.status === 'success') {
                            queryData.value = response.data.data || [];
                            queryPagination.value = response.data.pagination || queryPagination.value;
                        } else {
                            ElMessage.error(response.data.message || 'æŸ¥è¯¢å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('æŸ¥è¯¢è®¢å•å¤±è´¥:', error);
                        ElMessage.error('æŸ¥è¯¢è®¢å•å¤±è´¥: ' + (error.response?.data?.message || error.message));
                    } finally {
                        queryLoading.value = false;
                    }
                };

                // é‡ç½®æŸ¥è¯¢
                const resetQuery = () => {
                    queryBuilding.value = '';
                    queryRoomId.value = '';
                    queryData.value = [];
                    hasQueried.value = false;
                    dateError.value = '';
                    queryPagination.value = {
                        page: 1,
                        per_page: 10,
                        total: 0,
                        pages: 0
                    };
                    sortColumn.value = 'entryTime';
                    sortOrder.value = 'desc';
                    
                    // é‡ç½®æ—¥æœŸé€‰æ‹©å™¨
                    if (startTimePicker) {
                        startTimePicker.setDate(new Date(new Date().setHours(0, 0, 0, 0)));
                    }
                    if (endTimePicker) {
                        endTimePicker.setDate(new Date());
                    }
                };

                // æ’åº
                const sortByColumn = (column) => {
                    if (sortColumn.value === column) {
                        sortOrder.value = sortOrder.value === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn.value = column;
                        sortOrder.value = 'asc';
                    }
                    
                    if (hasQueried.value) {
                        queryOrders();
                    }
                };

                // åˆ†é¡µå¤„ç†
                const handleSizeChange = (val) => {
                    queryPagination.value.per_page = val;
                    queryPagination.value.page = 1;
                    if (hasQueried.value) {
                        queryOrders();
                    }
                };

                const handleCurrentChange = (val) => {
                    queryPagination.value.page = val;
                    if (hasQueried.value) {
                        queryOrders();
                    }
                };

                // æ ¼å¼åŒ–ä»·æ ¼
                const formatPrice = (price) => {
                    const num = parseFloat(price) || 0;
                    return num.toFixed(2);
                };

                // æ ¼å¼åŒ–æ—¥æœŸ
                const formatDate = (dateStr) => {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };

                // æ ¼å¼åŒ–æ”¶è´¹é¡¹ç›®
                const formatFeeItems = (feeItems) => {
                    if (!feeItems || !Array.isArray(feeItems)) return '-';
                    return feeItems.map(item => {
                        return `<span class="fee-item">${item.feeName}: Â¥${formatPrice(item.amount)}</span>`;
                    }).join(' ');
                };

                // å¤åˆ¶è®¢å•å·
                const copyOrderId = async (orderId) => {
                    try {
                        await navigator.clipboard.writeText(orderId);
                        showCopySuccess();
                    } catch (err) {
                        // é™çº§æ–¹æ¡ˆ
                        const textArea = document.createElement('textarea');
                        textArea.value = orderId;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showCopySuccess();
                    }
                };

                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                const showCopySuccess = () => {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'copy-success-tooltip';
                    tooltip.textContent = 'è®¢å•å·å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
                    document.body.appendChild(tooltip);
                    
                    setTimeout(() => {
                        if (document.body.contains(tooltip)) {
                            document.body.removeChild(tooltip);
                        }
                    }, 2000);
                };

                // æ˜¾ç¤ºè®¢å•è¯¦æƒ…
                const showOrderDetail = (order) => {
                    let details = `
                        <div style="padding: 20px;">
                            <h3 style="margin-bottom: 15px; color: #333;">è®¢å•è¯¦æƒ…</h3>
                            <p><strong>è®¢å•å·ï¼š</strong>${order.orderId}</p>
                            <p><strong>å®¢æˆ·å§“åï¼š</strong>${order.residentName || '-'}</p>
                            <p><strong>è”ç³»ç”µè¯ï¼š</strong>${order.residentPhone || '-'}</p>
                            <p><strong>åœ°å€ï¼š</strong>${order.building || '-'}-${order.room || '-'}</p>
                            <p><strong>æ”¶è´¹æ—¥æœŸï¼š</strong>${formatDate(order.entryTime)}</p>
                            <p><strong>æ€»é‡‘é¢ï¼š</strong>Â¥${formatPrice(order.totalAmount)}</p>
                            <p><strong>æ”¶è´¹é¡¹ç›®ï¼š</strong></p>
                            <div>${formatFeeItems(order.feeItems)}</div>
                        </div>
                    `;
                    
                    ElMessageBox.alert(details, 'è®¢å•è¯¦æƒ…', {
                        dangerouslyUseHTMLString: true,
                        confirmButtonText: 'ç¡®å®š'
                    });
                };

                // é€€å‡ºç™»å½•
                const logout = () => {
                    ElMessageBox.confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', 'æç¤º', {
                        confirmButtonText: 'ç¡®å®š',
                        cancelButtonText: 'å–æ¶ˆ',
                        type: 'warning'
                    }).then(() => {
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = '/login';
                    }).catch(() => {});
                };

                // ç»„ä»¶æŒ‚è½½
                onMounted(() => {
                    initDatePickers();
                    loadQueryBuildings();
                });

                return {
                    // ç”¨æˆ·ä¿¡æ¯
                    user,
                    
                    // è®¢å•æŸ¥è¯¢æ•°æ®
                    queryData,
                    queryBuildings,
                    queryRooms,
                    queryBuilding,
                    queryRoomId,
                    queryLoading,
                    hasQueried,
                    dateError,
                    queryPagination,
                    sortColumn,
                    sortOrder,
                    currentPageTotal,
                    
                    // æ–¹æ³•
                    loadQueryBuildings,
                    onQueryBuildingChange,
                    onQueryRoomChange,
                    queryOrders,
                    resetQuery,
                    sortByColumn,
                    handleSizeChange,
                    handleCurrentChange,
                    formatPrice,
                    formatDate,
                    formatFeeItems,
                    copyOrderId,
                    showOrderDetail,
                    logout
                };
            }
        });

        // ä½¿ç”¨Element Plus
        app.use(ElementPlus);

        // æŒ‚è½½åº”ç”¨
        app.mount('#app');
    </script>
</body>
</html>