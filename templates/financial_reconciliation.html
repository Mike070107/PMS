<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¢åŠ¡å¯¹è´¦æŠ¥è¡¨ - ç‰©ä¸šæ”¶è´¹ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    
    <script src="/static/lib/vue.global.js"></script>
    <script src="/static/lib/element-plus.full.js"></script>
    <link rel="stylesheet" href="/static/lib/element-plus.css">
    <script src="/static/lib/axios.min.js"></script>
    <script src="/static/lib/flatpickr/flatpickr.min.js"></script>
    <link rel="stylesheet" href="/static/lib/flatpickr/airbnb.css">
    <script src="/static/lib/flatpickr/zh.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            font-size: 14px;
            color: #333;
            background: #f5f7fa;
            padding: 20px;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        [v-cloak] {
            display: none;
        }

        .page-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            background: white;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .page-title {
            font-size: 22px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }

        .page-subtitle {
            font-size: 13px;
            color: #888;
        }

        .filter-card {
            background: white;
            padding: 20px 25px;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-end;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 13px;
            font-weight: 500;
            color: #666;
        }

        .filter-control {
            min-width: 180px;
        }

        .date-range {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-input {
            width: 140px;
            height: 34px;
            padding: 0 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .date-input:focus {
            border-color: #409eff;
        }

        .date-separator {
            color: #999;
            font-size: 13px;
        }

        .result-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .result-header {
            padding: 14px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-title {
            font-size: 15px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .result-summary {
            font-size: 13px;
            color: #666;
        }

        .result-summary .highlight {
            color: #e74c3c;
            font-weight: 600;
            font-size: 15px;
        }

        .table-container {
            padding: 16px 20px;
            overflow-x: auto;
        }

        .data-table {
            width: auto;
            min-width: 650px;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table th,
        .data-table td {
            padding: 14px 24px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }

        .data-table th {
            background: #fafafa;
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .data-table .amount {
            text-align: right;
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
            font-variant-numeric: tabular-nums;
        }

        .data-table .total-row {
            background: #f5f5f5;
            font-weight: 600;
        }

        .data-table .total-row td {
            border-top: 1px solid #ddd;
            color: #1a1a1a;
            font-size: 13px;
        }

        .data-table .total-amount {
            color: #e74c3c;
        }

        .empty-data {
            padding: 60px 20px;
            text-align: center;
            color: #909399;
        }

        .empty-data i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .loading-container {
            padding: 60px 20px;
            text-align: center;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        /* Element Plus æ ·å¼è¦†ç›– */
        .el-button--primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }

        .el-button--primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
    </style>
</head>
<body>
{% raw %}
    <div id="app" v-cloak>
        <div class="page-container">
            <div class="page-header">
                <h1 class="page-title">è´¢åŠ¡å¯¹è´¦æŠ¥è¡¨</h1>
                <p class="page-subtitle">æŒ‰åœ°åŒºå’Œæ—¥æœŸæŸ¥è¯¢æ¯æ—¥æ”¶æ¬¾æ±‡æ€»ï¼Œæ”¯æŒæŒ‰æ”¶æ¬¾æ–¹å¼åˆ†ç±»ç»Ÿè®¡</p>
            </div>

            <!-- æŸ¥è¯¢æ¡ä»¶ -->
            <div class="filter-card">
                <div class="filter-row">
                    <!-- åœ°åŒºé€‰æ‹© -->
                    <div class="filter-item">
                        <div class="filter-label">é€‰æ‹©åœ°åŒº</div>
                        <div class="filter-control">
                            <el-select 
                                v-model="queryParams.community" 
                                placeholder="è¯·é€‰æ‹©åœ°åŒº"
                                :disabled="isCommunityDisabled"
                                :clearable="!isCommunityDisabled"
                                style="width: 180px;">
                                <el-option
                                    v-for="community in communities"
                                    :key="community"
                                    :label="community"
                                    :value="community">
                                </el-option>
                            </el-select>
                        </div>
                    </div>

                    <!-- æ—¥æœŸèŒƒå›´ -->
                    <div class="filter-item">
                        <div class="filter-label">æ—¥æœŸèŒƒå›´</div>
                        <div class="date-range">
                            <input type="text" class="date-input" id="startDate" placeholder="å¼€å§‹æ—¥æœŸ" v-model="queryParams.startDate">
                            <span class="date-separator">è‡³</span>
                            <input type="text" class="date-input" id="endDate" placeholder="ç»“æŸæ—¥æœŸ" v-model="queryParams.endDate">
                        </div>
                    </div>

                    <!-- æŒ‰é’® -->
                    <div class="filter-item">
                        <div class="filter-label">&nbsp;</div>
                        <el-button type="primary" @click="queryData" :loading="loading">
                            æŸ¥è¯¢
                        </el-button>
                    </div>
                </div>
            </div>

            <!-- æŸ¥è¯¢ç»“æœ -->
            <div class="result-card">
                <div class="result-header">
                    <span class="result-title">æŸ¥è¯¢ç»“æœ</span>
                    <span class="result-summary" v-if="tableData.length > 0">
                        å…± <span class="highlight">{{ tableData.length }}</span> æ¡è®°å½•ï¼Œ
                        åˆè®¡æ”¶æ¬¾ <span class="highlight">Â¥{{ formatNumber(totalAmount) }}</span>
                    </span>
                </div>

                <!-- åŠ è½½ä¸­ -->
                <div class="loading-container" v-if="loading">
                    <el-icon class="is-loading" :size="32" color="#409eff">
                        <i class="el-icon-loading"></i>
                    </el-icon>
                    <p style="margin-top: 10px; color: #909399;">åŠ è½½ä¸­...</p>
                </div>

                <!-- æ•°æ®è¡¨æ ¼ -->
                <div class="table-container" v-else-if="tableData.length > 0">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>å°åŒºåç§°</th>
                                <th>æ—¥æœŸ</th>
                                <th class="amount">å¾®ä¿¡æ”¶æ¬¾</th>
                                <th class="amount">æ”¯ä»˜å®æ”¶æ¬¾</th>
                                <th class="amount">ç°é‡‘æ”¶æ¬¾</th>
                                <th class="amount">åˆè®¡é‡‘é¢</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(row, index) in tableData" :key="index">
                                <td>{{ row.community }}</td>
                                <td>{{ row.date }}</td>
                                <td class="amount">Â¥{{ formatNumber(row.wechatAmount) }}</td>
                                <td class="amount">Â¥{{ formatNumber(row.alipayAmount) }}</td>
                                <td class="amount">Â¥{{ formatNumber(row.cashAmount) }}</td>
                                <td class="amount">Â¥{{ formatNumber(row.totalAmount) }}</td>
                            </tr>
                            <!-- åˆè®¡è¡Œ -->
                            <tr class="total-row">
                                <td colspan="2" style="text-align: right;">åˆè®¡</td>
                                <td class="amount">Â¥{{ formatNumber(sumWechat) }}</td>
                                <td class="amount">Â¥{{ formatNumber(sumAlipay) }}</td>
                                <td class="amount">Â¥{{ formatNumber(sumCash) }}</td>
                                <td class="amount total-amount">Â¥{{ formatNumber(totalAmount) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ç©ºæ•°æ® -->
                <div class="empty-data" v-else>
                    <i>ğŸ“Š</i>
                    <p>è¯·é€‰æ‹©æŸ¥è¯¢æ¡ä»¶åç‚¹å‡»æŸ¥è¯¢</p>
                </div>
            </div>
        </div>
    </div>
{% endraw %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const { createApp, ref, computed, onMounted } = Vue;
    const { ElMessage } = ElementPlus;

    const app = createApp({
        setup() {
            // ç”¨æˆ·ä¿¡æ¯
            const userInfo = ref(JSON.parse(sessionStorage.getItem('user') || '{}'));
            const token = sessionStorage.getItem('token');

            // æŸ¥è¯¢å‚æ•°
            const queryParams = ref({
                community: '',
                startDate: '',
                endDate: ''
            });

            // æ•°æ®
            const communities = ref([]);
            const tableData = ref([]);
            const loading = ref(false);

            // æ˜¯å¦ç¦ç”¨åœ°åŒºé€‰æ‹©ï¼ˆéç®¡ç†å‘˜åªèƒ½çœ‹è‡ªå·±å°åŒºï¼‰
            const isCommunityDisabled = computed(() => {
                return userInfo.value.role !== 'ç³»ç»Ÿç®¡ç†å‘˜';
            });

            // è®¡ç®—åˆè®¡
            const sumWechat = computed(() => tableData.value.reduce((sum, row) => sum + row.wechatAmount, 0));
            const sumAlipay = computed(() => tableData.value.reduce((sum, row) => sum + row.alipayAmount, 0));
            const sumCash = computed(() => tableData.value.reduce((sum, row) => sum + row.cashAmount, 0));
            const totalAmount = computed(() => tableData.value.reduce((sum, row) => sum + row.totalAmount, 0));

            // æ ¼å¼åŒ–æ•°å­—
            const formatNumber = (num) => {
                return (num || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            };

            // åŠ è½½å°åŒºåˆ—è¡¨
            const loadCommunities = async () => {
                try {
                    const response = await axios.get('/api/communities', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.data.status === 'success') {
                        communities.value = response.data.data;
                        // éç®¡ç†å‘˜é»˜è®¤é€‰ä¸­è‡ªå·±çš„å°åŒº
                        if (isCommunityDisabled.value && communities.value.length > 0) {
                            queryParams.value.community = userInfo.value.community || communities.value[0];
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½å°åŒºåˆ—è¡¨å¤±è´¥:', error);
                }
            };

            // æŸ¥è¯¢æ•°æ®
            const queryData = async () => {
                if (!queryParams.value.community) {
                    ElMessage.warning('è¯·é€‰æ‹©åœ°åŒº');
                    return;
                }
                if (!queryParams.value.startDate || !queryParams.value.endDate) {
                    ElMessage.warning('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
                    return;
                }

                loading.value = true;
                try {
                    const response = await axios.get('/api/reports/financial-reconciliation', {
                        params: {
                            community: queryParams.value.community,
                            start_date: queryParams.value.startDate,
                            end_date: queryParams.value.endDate
                        },
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.data.status === 'success') {
                        tableData.value = response.data.data;
                        if (tableData.value.length === 0) {
                            ElMessage.info('æœªæŸ¥è¯¢åˆ°æ•°æ®');
                        }
                    } else {
                        ElMessage.error(response.data.message || 'æŸ¥è¯¢å¤±è´¥');
                    }
                } catch (error) {
                    console.error('æŸ¥è¯¢å¤±è´¥:', error);
                    ElMessage.error('æŸ¥è¯¢å¤±è´¥ï¼Œè¯·é‡è¯•');
                } finally {
                    loading.value = false;
                }
            };

            // å¯¼å‡ºExcel
            const exportExcel = () => {
                if (tableData.value.length === 0) {
                    ElMessage.warning('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                    return;
                }

                const params = new URLSearchParams({
                    community: queryParams.value.community,
                    start_date: queryParams.value.startDate,
                    end_date: queryParams.value.endDate
                });

                window.open(`/api/reports/financial-reconciliation/export?${params.toString()}`, '_blank');
            };

            // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
            const initDatePickers = () => {
                const config = {
                    locale: 'zh',
                    dateFormat: 'Y-m-d',
                    allowInput: true
                };

                flatpickr('#startDate', {
                    ...config,
                    onChange: (dates, dateStr) => {
                        queryParams.value.startDate = dateStr;
                    }
                });

                flatpickr('#endDate', {
                    ...config,
                    onChange: (dates, dateStr) => {
                        queryParams.value.endDate = dateStr;
                    }
                });
            };

            onMounted(() => {
                loadCommunities();
                initDatePickers();

                // é»˜è®¤æ—¥æœŸï¼šæœ¬æœˆ1å·åˆ°ä»Šå¤©
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                queryParams.value.startDate = firstDay.toISOString().split('T')[0];
                queryParams.value.endDate = now.toISOString().split('T')[0];

                // æ›´æ–°æ—¥æœŸé€‰æ‹©å™¨æ˜¾ç¤º
                setTimeout(() => {
                    document.getElementById('startDate').value = queryParams.value.startDate;
                    document.getElementById('endDate').value = queryParams.value.endDate;
                }, 100);
            });

            return {
                userInfo,
                queryParams,
                communities,
                tableData,
                loading,
                isCommunityDisabled,
                sumWechat,
                sumAlipay,
                sumCash,
                totalAmount,
                formatNumber,
                queryData,
                exportExcel
            };
        }
    });

    app.use(ElementPlus);
    app.mount('#app');
});
</script>
</body>
</html>
