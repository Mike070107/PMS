<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单查询 - 物业收费系统</title>
    <link rel="stylesheet" href="/static/lib/element-plus.css">
    <link rel="stylesheet" href="/static/lib/element-plus-icons.css">
    <script src="/static/lib/vue@3.3.4.global.prod.js"></script>
    <script src="/static/lib/element-plus.full.min.js"></script>
    <script src="/static/lib/element-plus-icons-vue.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f7fa;
            color: #303133;
        }

        #app {
            min-height: 100vh;
        }

        .header {
            background-color: #409EFF;
            color: white;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .order-query-container {
            padding: 24px;
            background-color: #fff;
            min-height: calc(100vh - 64px);
        }

        .filter-card {
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            height: 40px;
        }

        :deep(.el-form-item) {
            margin-bottom: 0;
            width: 100%;
        }

        :deep(.el-form-item__label) {
            font-size: 14px;
            color: #606266;
            height: 32px;
            line-height: 32px;
        }

        :deep(.el-form-item__content-wrap) {
            display: flex;
            align-items: center;
        }

        :deep(.el-checkbox) {
            margin-right: 8px;
            height: 32px;
            line-height: 32px;
            display: inline-flex;
            align-items: center;
        }

        :deep(.el-checkbox__input) {
            vertical-align: middle;
        }

        :deep(.el-checkbox__label) {
            line-height: 32px;
        }

        :deep(.el-form-item__content) {
            line-height: 32px;
            display: flex;
            align-items: center;
        }

        :deep(.el-input__wrapper) {
            box-shadow: none !important;
            border: none !important;
            background-color: transparent !important;
            padding: 0 !important;
        }

        :deep(.el-input__inner) {
            border: none !important;
            box-shadow: none !important;
            background-color: transparent !important;
            height: 32px;
            line-height: 32px;
        }

        :deep(.el-select__wrapper) {
            box-shadow: none !important;
            border: 1px solid #dcdfe6 !important;
            background-color: #ffffff !important;
            padding: 0 8px !important;
            min-height: 32px;
        }

        :deep(.el-select__selected-item) {
            color: #606266 !important;
            font-size: 14px !important;
            display: inline-block !important;
        }

        :deep(.el-select__placeholder) {
            color: #a8abb2 !important;
            font-size: 14px !important;
        }

        :deep(.el-select__wrapper.is-focused) {
            border-color: #409eff !important;
        }

        :deep(.wider-select) {
            width: 100% !important;
        }

        :deep(.el-select-dropdown) {
            max-height: none !important;
        }

        :deep(.el-select-dropdown__wrap) {
            max-height: 300px !important;
            overflow-y: auto !important;
        }

        :deep(.el-select-dropdown__list) {
            padding: 6px 0 !important;
        }

        :deep(.el-select-dropdown__item) {
            height: 34px !important;
            line-height: 34px !important;
            padding: 0 20px !important;
        }

        .custom-select-dropdown {
            max-height: 300px !important;
            overflow-y: auto !important;
        }

        .custom-select-dropdown .el-select-dropdown__wrap {
            max-height: 300px !important;
        }

        .filter-actions {
            display: flex;
            align-items: center;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #EBEEF5;
        }

        .results-section {
            min-height: 400px;
        }

        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            position: relative;
        }

        .loading-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1;
        }

        .custom-loading {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #409EFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: #606266;
            font-weight: 500;
        }

        .empty-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }

        .pagination-container {
            display: flex;
            justify-content: flex-end;
            padding: 16px;
            background-color: #fff;
            border-top: 1px solid #E5E6EB;
        }

        .summary-container {
            padding: 16px;
            background-color: #fff;
            border-top: 1px solid #E5E6EB;
        }

        .order-detail-content {
            padding: 8px 0;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 14px;
            color: #606266;
            font-weight: 500;
        }

        .detail-value {
            font-size: 14px;
            color: #303133;
            font-weight: 400;
        }

        .total-row {
            margin-top: 8px;
            padding-top: 16px;
            border-top: 2px solid #409EFF;
        }

        .total-amount {
            font-size: 18px;
            color: #409EFF;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .order-query-container {
                padding: 12px;
            }

            .filter-item {
                height: auto;
                flex-direction: column;
                align-items: flex-start;
            }

            :deep(.el-form-item) {
                width: 100%;
            }

            :deep(.el-col) {
                margin-bottom: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div class="header-title">订单查询</div>
            <div class="header-actions">
                <el-button type="primary" size="small" @click="goBack">
                    <i class="el-icon-back"></i> 返回
                </el-button>
            </div>
        </div>

        <div class="order-query-container">
            <el-card class="filter-card">
                <el-row :gutter="20">
                    <el-col :span="8">
                        <div class="filter-item">
                            <el-checkbox v-model="enabled.billNo" />
                            <el-form-item label="账单号">
                                <el-input v-model="queryForm.billNo" :disabled="!enabled.billNo" placeholder="精确匹配" />
                            </el-form-item>
                        </div>
                    </el-col>

                    <el-col :span="8">
                        <div class="filter-item">
                            <el-checkbox v-model="enabled.operator" />
                            <el-form-item label="操作员账号">
                                <el-input v-model="queryForm.operator" :disabled="!enabled.operator" placeholder="操作员账号" />
                            </el-form-item>
                        </div>
                    </el-col>

                    <el-col :span="8">
                        <div class="filter-item">
                            <el-checkbox v-model="enabled.carPlate" />
                            <el-form-item label="车牌号">
                                <el-input 
                                    v-model="queryForm.carPlate" 
                                    :disabled="!enabled.carPlate" 
                                    placeholder="模糊匹配"
                                    :error="!!carPlateError" />
                            </el-form-item>
                        </div>
                    </el-col>
                </el-row>

                <el-row :gutter="20">
                    <el-col :span="8">
                        <div class="filter-item">
                            <el-checkbox v-model="enabled.item" />
                            <el-form-item label="收费项目">
                                <el-select v-model="queryForm.item" :disabled="!enabled.item" placeholder="请选择" clearable class="wider-select" popper-class="custom-select-dropdown">
                                    <el-option label="电费" value="电费" />
                                    <el-option label="热水费" value="热水费" />
                                    <el-option label="冷水费" value="冷水费" />
                                    <el-option label="网费" value="网费" />
                                    <el-option label="停车费" value="停车费" />
                                    <el-option label="房租" value="房租" />
                                    <el-option label="管理费" value="管理费" />
                                </el-select>
                            </el-form-item>
                        </div>
                    </el-col>

                    <el-col :span="8">
                        <div class="filter-item">
                            <el-checkbox v-model="enabled.method" />
                            <el-form-item label="收款方式">
                                <el-select v-model="queryForm.method" :disabled="!enabled.method" placeholder="请选择" clearable class="wider-select">
                                    <el-option label="微信" value="微信" />
                                    <el-option label="支付宝" value="支付宝" />
                                    <el-option label="现金" value="现金" />
                                </el-select>
                            </el-form-item>
                        </div>
                    </el-col>

                    <el-col :span="8">
                        <div class="filter-item">
                            <el-checkbox v-model="enabled.timeRange" />
                            <el-form-item label="录入时间">
                                <el-date-picker
                                    v-model="queryForm.timeRange"
                                    type="daterange"
                                    range-separator="至"
                                    start-placeholder="开始日期"
                                    end-placeholder="结束日期"
                                    :disabled="!enabled.timeRange"
                                    style="width: 100%;" />
                            </el-form-item>
                        </div>
                    </el-col>
                </el-row>

                <div class="filter-actions">
                    <el-button type="primary" @click="handleQuery" :loading="queryLoading" :disabled="isQueryDisabled">
                        <i class="el-icon-search"></i> 查询
                    </el-button>
                    <el-button @click="resetQuery">
                        <i class="el-icon-refresh-left"></i> 重置
                    </el-button>
                    <el-alert v-if="carPlateError" :title="carPlateError" type="error" :closable="false" style="margin-left: 10px;" />
                </div>
            </el-card>

            <div class="results-section">
                <div v-if="queryLoading" class="loading-container">
                    <div class="custom-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">加载中...</div>
                    </div>
                </div>

                <div v-else-if="!hasQueried" class="empty-container">
                    <el-empty description="请选择查询条件后点击查询按钮"></el-empty>
                </div>

                <div v-else-if="queryData.length === 0" class="empty-container">
                    <el-empty description="暂无查询结果"></el-empty>
                </div>

                <div v-else class="table-container">
                    <el-table 
                        :data="queryData" 
                        border 
                        stripe 
                        style="width: 100%"
                        @sort-change="handleSortChange">
                        <el-table-column 
                            prop="billNumber" 
                            label="账单号" 
                            width="150"
                            sortable="custom">
                        </el-table-column>

                        <el-table-column 
                            prop="operatorAccount" 
                            label="操作员账号" 
                            width="120">
                        </el-table-column>

                        <el-table-column 
                            prop="building" 
                            label="楼栋号" 
                            width="80">
                        </el-table-column>

                        <el-table-column 
                            prop="room" 
                            label="房间号" 
                            width="80">
                        </el-table-column>

                        <el-table-column 
                            prop="entryTime" 
                            label="录入时间" 
                            width="180"
                            sortable="custom">
                        </el-table-column>

                        <el-table-column 
                            prop="totalAmount" 
                            label="收款金额(元)" 
                            width="120"
                            sortable="custom">
                            <template #default="scope">
                                <span :style="{ color: scope.row.totalAmount < 0 ? '#f56c6c' : '' }">
                                    ¥{{ scope.row.totalAmount.toFixed(2) }}
                                </span>
                            </template>
                        </el-table-column>

                        <el-table-column 
                            prop="paymentMethod" 
                            label="收款方式" 
                            width="100">
                        </el-table-column>

                        <el-table-column 
                            prop="remark" 
                            label="备注" 
                            min-width="150"
                            show-overflow-tooltip>
                        </el-table-column>

                        <el-table-column 
                            label="操作" 
                            width="100" 
                            fixed="right">
                            <template #default="scope">
                                <el-button 
                                    type="text" 
                                    size="small" 
                                    @click="handleViewDetail(scope.row)">
                                    查看详情
                                </el-button>
                            </template>
                        </el-table-column>
                    </el-table>

                    <div class="pagination-container">
                        <el-pagination
                            v-model:current-page="queryPagination.page"
                            v-model:page-size="queryPagination.per_page"
                            :page-sizes="[10, 20, 50, 100]"
                            :total="queryPagination.total"
                            layout="total, sizes, prev, pager, next, jumper"
                            @size-change="handleSizeChange"
                            @current-change="handleCurrentChange">
                        </el-pagination>
                    </div>

                    <div class="summary-container">
                        <el-alert 
                            :title="`当前页合计金额: ¥${currentPageTotal.toFixed(2)}`" 
                            type="info" 
                            :closable="false">
                        </el-alert>
                    </div>
                </div>
            </div>

            <el-dialog 
                v-model="orderDetailVisible" 
                title="订单详情" 
                width="600px"
                :close-on-click-modal="false">
                <div v-if="orderDetailData" class="order-detail-content">
                    <div class="detail-row">
                        <span class="detail-label">账单号：</span>
                        <span class="detail-value">{{ orderDetailData.billNumber }}</span>
                    </div>

                    <el-divider></el-divider>

                    <div class="detail-row">
                        <span class="detail-label">电费：</span>
                        <span class="detail-value">
                            {{ orderDetailData.electricityDegree }}度 / ¥{{ orderDetailData.electricityAmount.toFixed(2) }}
                        </span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">热水：</span>
                        <span class="detail-value">
                            {{ orderDetailData.hotWaterTonnage }}吨 / ¥{{ orderDetailData.hotWaterAmount.toFixed(2) }}
                        </span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">冷水：</span>
                        <span class="detail-value">
                            {{ orderDetailData.coldWaterTonnage }}吨 / ¥{{ orderDetailData.coldWaterAmount.toFixed(2) }}
                        </span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">网费：</span>
                        <span class="detail-value">
                            {{ orderDetailData.networkMonths }}个月 / ¥{{ orderDetailData.networkAmount.toFixed(2) }}
                        </span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">停车费：</span>
                        <span class="detail-value">
                            {{ orderDetailData.parkingMonths }}个月 / ¥{{ orderDetailData.parkingAmount.toFixed(2) }}
                        </span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">车牌号：</span>
                        <span class="detail-value">{{ orderDetailData.carPlate }}</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">房租：</span>
                        <span class="detail-value">
                            {{ orderDetailData.rentMonths }}个月 / ¥{{ orderDetailData.rentAmount.toFixed(2) }}
                        </span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">管理费：</span>
                        <span class="detail-value">
                            {{ orderDetailData.managementMonths }}个月 / ¥{{ orderDetailData.managementAmount.toFixed(2) }}
                        </span>
                    </div>

                    <el-divider></el-divider>

                    <div class="detail-row total-row">
                        <span class="detail-label">合计金额：</span>
                        <span class="detail-value total-amount">
                            ¥{{ calculateOrderTotal().toFixed(2) }}
                        </span>
                    </div>
                </div>
            </el-dialog>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        const app = createApp({
            setup() {
                const queryData = ref([]);
                const queryLoading = ref(false);
                const queryPagination = ref({
                    page: 1,
                    per_page: 10,
                    total: 0,
                    pages: 0
                });
                const sortColumn = ref('');
                const sortOrder = ref('desc');
                const hasQueried = ref(false);
                const currentPageTotal = ref(0);
                const dateError = ref('');

                const enabled = reactive({
                    billNo: false,
                    operator: false,
                    carPlate: false,
                    item: false,
                    method: false,
                    timeRange: false
                });

                const queryForm = reactive({
                    billNo: '',
                    operator: '',
                    carPlate: '',
                    item: '',
                    method: '',
                    timeRange: []
                });

                const orderDetailVisible = ref(false);
                const orderDetailData = ref(null);

                const carPlateError = computed(() => {
                    if (enabled.carPlate && queryForm.carPlate.length > 0 && queryForm.carPlate.length < 4) {
                        return '车牌号至少输入4位';
                    }
                    return '';
                });

                const isQueryDisabled = computed(() => !!carPlateError.value);

                const validateDateRange = () => {
                    if (enabled.timeRange && queryForm.timeRange && queryForm.timeRange.length === 2) {
                        const start = new Date(queryForm.timeRange[0]);
                        const end = new Date(queryForm.timeRange[1]);
                        
                        if (start > end) {
                            dateError.value = '开始时间不能晚于结束时间';
                            return false;
                        }
                    }
                    
                    dateError.value = '';
                    return true;
                };

                const handleQuery = async () => {
                    if (!validateDateRange()) {
                        return;
                    }

                    queryLoading.value = true;
                    hasQueried.value = true;

                    try {
                        const token = sessionStorage.getItem('token');
                        const params = new URLSearchParams();

                        params.append('page', queryPagination.value.page);
                        params.append('per_page', queryPagination.value.per_page);

                        params.append('billNumberEnabled', enabled.billNo);
                        if (enabled.billNo && queryForm.billNo) {
                            params.append('billNumber', queryForm.billNo);
                        }

                        params.append('operatorEnabled', enabled.operator);
                        if (enabled.operator && queryForm.operator) {
                            params.append('operator', queryForm.operator);
                        }

                        params.append('feeItemEnabled', enabled.item);
                        if (enabled.item && queryForm.item) {
                            params.append('feeItem', queryForm.item);
                        }

                        params.append('paymentMethodEnabled', enabled.method);
                        if (enabled.method && queryForm.method) {
                            params.append('paymentMethod', queryForm.method);
                        }

                        params.append('carPlateEnabled', enabled.carPlate);
                        if (enabled.carPlate && queryForm.carPlate) {
                            params.append('carPlate', queryForm.carPlate);
                        }

                        params.append('timeRangeEnabled', enabled.timeRange);
                        if (enabled.timeRange && queryForm.timeRange && queryForm.timeRange.length === 2) {
                            params.append('startTime', queryForm.timeRange[0]);
                            params.append('endTime', queryForm.timeRange[1]);
                        }

                        const response = await fetch(`/api/orders/advanced-query?${params.toString()}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        const result = await response.json();
                        if (result.status === 'success') {
                            queryData.value = result.data;
                            queryPagination.value = result.pagination;

                            currentPageTotal.value = result.data.reduce((sum, order) => sum + order.totalAmount, 0);
                        } else {
                            ElMessage.error(result.message || '查询订单失败');
                            queryData.value = [];
                            queryPagination.value.total = 0;
                            currentPageTotal.value = 0;
                        }
                    } catch (error) {
                        console.error('查询订单失败:', error);
                        ElMessage.error('网络请求失败');
                        queryData.value = [];
                        queryPagination.value.total = 0;
                        currentPageTotal.value = 0;
                    } finally {
                        queryLoading.value = false;
                    }
                };

                const resetQuery = () => {
                    Object.keys(enabled).forEach(k => enabled[k] = false);
                    queryForm.billNo = '';
                    queryForm.operator = '';
                    queryForm.carPlate = '';
                    queryForm.item = '';
                    queryForm.method = '';
                    queryForm.timeRange = [];

                    queryPagination.value = {
                        page: 1,
                        per_page: 10,
                        total: 0,
                        pages: 0
                    };

                    queryData.value = [];
                    hasQueried.value = false;
                    currentPageTotal.value = 0;
                };

                const handleViewDetail = async (order) => {
                    try {
                        const token = sessionStorage.getItem('token');
                        const response = await fetch(`/api/orders/${order.orderId}/detail`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        const result = await response.json();
                        if (result.status === 'success') {
                            orderDetailData.value = result.data;
                            orderDetailVisible.value = true;
                        } else {
                            ElMessage.error(result.message || '获取订单详情失败');
                        }
                    } catch (error) {
                        console.error('获取订单详情失败:', error);
                        ElMessage.error('网络请求失败');
                    }
                };

                const calculateOrderTotal = () => {
                    if (!orderDetailData.value) return 0;
                    
                    return (
                        orderDetailData.value.electricityAmount +
                        orderDetailData.value.hotWaterAmount +
                        orderDetailData.value.coldWaterAmount +
                        orderDetailData.value.networkAmount +
                        orderDetailData.value.parkingAmount +
                        orderDetailData.value.rentAmount +
                        orderDetailData.value.managementAmount
                    );
                };

                const handleSortChange = ({ prop, order }) => {
                    if (!order) {
                        sortColumn.value = '';
                        sortOrder.value = 'desc';
                    } else {
                        sortColumn.value = prop;
                        sortOrder.value = order === 'ascending' ? 'asc' : 'desc';
                    }
                    
                    if (hasQueried.value) {
                        handleQuery();
                    }
                };

                const handleSizeChange = (size) => {
                    queryPagination.value.per_page = size;
                    queryPagination.value.page = 1;
                    if (hasQueried.value) {
                        handleQuery();
                    }
                };

                const handleCurrentChange = (page) => {
                    queryPagination.value.page = page;
                    if (hasQueried.value) {
                        handleQuery();
                    }
                };

                const goBack = () => {
                    window.location.href = '/';
                };

                return {
                    queryData,
                    queryLoading,
                    queryPagination,
                    sortColumn,
                    sortOrder,
                    hasQueried,
                    currentPageTotal,
                    dateError,
                    enabled,
                    queryForm,
                    carPlateError,
                    isQueryDisabled,
                    orderDetailVisible,
                    orderDetailData,
                    validateDateRange,
                    handleQuery,
                    resetQuery,
                    handleViewDetail,
                    calculateOrderTotal,
                    handleSortChange,
                    handleSizeChange,
                    handleCurrentChange,
                    goBack
                };
            }
        });

        app.use(ElementPlus).mount('#app');
    </script>
</body>
</html>