<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æŠ¥è¡¨ - ç‰©ä¸šæ”¶è´¹ç®¡ç†ç³»ç»Ÿ</title>
    
    <script src="/static/lib/vue.global.js"></script>
    <script src="/static/lib/element-plus.full.js"></script>
    <link rel="stylesheet" href="/static/lib/element-plus.css">
    <script src="/static/lib/axios.min.js"></script>
    <!-- ä½¿ç”¨æœ¬åœ° ECharts å’Œ Flatpickr -->
    <script src="/static/lib/echarts.min.js"></script>
    <script src="/static/lib/flatpickr/flatpickr.min.js"></script>
    <link rel="stylesheet" href="/static/lib/flatpickr/airbnb.css">
    <script src="/static/lib/flatpickr/zh.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            padding: 20px;
            min-height: 100vh;
        }

        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .page-subtitle {
            font-size: 15px;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        /* ç­›é€‰åŒºåŸŸ */
        .filter-section {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .filter-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-label {
            font-weight: 500;
            color: #495057;
            font-size: 14px;
            white-space: nowrap;
        }

        .date-input-wrapper {
            position: relative;
            width: 250px;
        }

        .datetime-input {
            width: 250px;
            height: 40px;
            padding: 0 35px 0 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: #fafafa;
            cursor: pointer;
        }

        .datetime-input:hover {
            border-color: #667eea;
            background: white;
        }

        .datetime-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            outline: none;
            background: white;
        }

        /* æ•°æ®æ¦‚è§ˆå¡ç‰‡ */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .stat-card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            border-radius: 16px 16px 0 0;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            opacity: 0.05;
            transition: all 0.4s ease;
        }

        .stat-card:hover::after {
            transform: scale(1.5);
            opacity: 0.1;
        }

        .stat-card.primary::before {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card.primary::after {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card.success::before {
            background: linear-gradient(135deg, #67C23A 0%, #85CE61 100%);
        }

        .stat-card.success::after {
            background: linear-gradient(135deg, #67C23A 0%, #85CE61 100%);
        }

        .stat-card.warning::before {
            background: linear-gradient(135deg, #E6A23C 0%, #EEBE77 100%);
        }

        .stat-card.warning::after {
            background: linear-gradient(135deg, #E6A23C 0%, #EEBE77 100%);
        }

        .stat-card.danger::before {
            background: linear-gradient(135deg, #F56C6C 0%, #F78989 100%);
        }

        .stat-card.danger::after {
            background: linear-gradient(135deg, #F56C6C 0%, #F78989 100%);
        }

        .stat-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: inline-block;
            animation: bounce 2s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .stat-label {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .stat-change {
            font-size: 12px;
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .stat-change.up {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        .stat-change.down {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        /* å›¾è¡¨å®¹å™¨ */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .chart-card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(-4px);
        }

        .chart-card:nth-child(1) { animation: fadeInUp 0.6s ease-out 0.6s both; }
        .chart-card:nth-child(2) { animation: fadeInUp 0.6s ease-out 0.7s both; }
        .chart-card:nth-child(3) { animation: fadeInUp 0.6s ease-out 0.8s both; }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid transparent;
            border-image: linear-gradient(90deg, #667eea 0%, #764ba2 50%, transparent 100%);
            border-image-slice: 1;
            position: relative;
        }

        .chart-title::before {
            content: 'ğŸ“Š';
            margin-right: 8px;
            font-size: 20px;
        }

        .chart-container {
            width: 100%;
            height: 400px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .el-button {
            border-radius: 8px;
            font-weight: 600;
            height: 42px;
            padding: 0 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .el-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .el-button:hover::before {
            width: 300px;
            height: 300px;
        }

        .el-button--primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .el-button--primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
            transform: translateY(-2px);
        }

        .el-button:not(.el-button--primary) {
            background: white;
            border: 2px solid #e5e7eb;
        }

        .el-button:not(.el-button--primary):hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* å•é€‰æŒ‰é’®ç»„ */
        .dimension-tabs {
            display: flex;
            gap: 12px;
            margin-left: 20px;
            background: #f5f7fa;
            padding: 6px;
            border-radius: 10px;
        }

        .dimension-tab {
            padding: 10px 20px;
            border: 2px solid transparent;
            border-radius: 8px;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .dimension-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .dimension-tab:hover::before {
            left: 100%;
        }

        .dimension-tab:hover {
            border-color: #667eea;
            color: #667eea;
            background: white;
            transform: translateY(-2px);
        }

        .dimension-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            gap: 20px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(102, 126, 234, 0.1);
            border-top: 5px solid #667eea;
            border-right: 5px solid #764ba2;
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #667eea;
            font-size: 16px;
            font-weight: 600;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* æ‰“å°æ ·å¼ */
        @media print {
            body {
                background: white !important;
                padding: 10px;
            }

            /* éšè—ç­›é€‰åŒºåŸŸå’ŒæŒ‰é’® */
            .filter-section,
            .el-button,
            .loading {
                display: none !important;
            }

            /* é¡µé¢æ ‡é¢˜ä¼˜åŒ– */
            /* é¡µé¢å¤´éƒ¨ - è‡ªé€‚åº”é«˜åº¦ */
            .page-header {
                background: none !important;
                color: #2c3e50 !important;
                box-shadow: none !important;
                border-bottom: 3px solid #2c3e50;
                padding: 30px 20px !important;  /* å¢åŠ å†…è¾¹è· */
                margin-bottom: 20px !important;
                height: auto !important;  /* è‡ªé€‚åº”é«˜åº¦ */
                min-height: auto !important;
            }

            .page-header::before {
                display: none !important;
            }

            .page-title {
                font-size: 28px !important;  /* å¢å¤§æ ‡é¢˜ */
                text-shadow: none !important;
                margin-bottom: 10px !important;
            }

            .page-subtitle {
                font-size: 14px !important;  /* å¢å¤§å‰¯æ ‡é¢˜ */
            }

            /* æ•°æ®æ¦‚è§ˆå¡ç‰‡æ‰“å°ä¼˜åŒ– */
            .stats-cards {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 10px !important;
                margin-bottom: 15px !important;
            }

            .stat-card {
                box-shadow: none !important;
                border: 2px solid #ddd !important;
                border-radius: 8px !important;
                page-break-inside: avoid;
                padding: 15px !important;
                background: white !important;
            }

            .stat-card::before {
                height: 3px !important;
            }

            .stat-card::after {
                display: none !important;
            }

            /* ä¿®å¤æ•°æ®å€¼æ˜¾ç¤ºé—®é¢˜ */
            .stat-value {
                color: #2c3e50 !important;
                -webkit-text-fill-color: #2c3e50 !important;
                background: none !important;
                -webkit-background-clip: initial !important;
                background-clip: initial !important;
                font-size: 28px !important;
                font-weight: 700 !important;
            }

            .stat-icon {
                font-size: 36px !important;
                margin-bottom: 8px !important;
                animation: none !important;
                filter: none !important;
            }

            .stat-label {
                font-size: 12px !important;
                color: #666 !important;
                margin-bottom: 8px !important;
            }

            .stat-change {
                font-size: 11px !important;
                padding: 2px 6px !important;
            }

            /* å›¾è¡¨åŒºåŸŸä¼˜åŒ– - è‡ªé€‚åº”é«˜åº¦ */
            .charts-grid {
                display: block !important;
                margin-bottom: 0 !important;
            }

            .chart-card {
                box-shadow: none !important;
                border: 2px solid #ddd !important;
                border-radius: 8px !important;
                page-break-inside: avoid;
                margin-bottom: 25px !important;  /* å¢åŠ å¡ç‰‡é—´è· */
                padding: 25px 20px !important;  /* å¢åŠ å†…è¾¹è· */
                background: white !important;
                overflow: visible !important;
                height: auto !important;  /* è‡ªé€‚åº”é«˜åº¦ */
                min-height: 450px !important;  /* å¢åŠ æœ€å°é«˜åº¦ */
            }

            .chart-card.full-width {
                grid-column: auto !important;
                min-height: 500px !important;  /* å…¨å®½å›¾è¡¨éœ€è¦æ›´é«˜ */
            }

            .chart-title {
                font-size: 16px !important;
                color: #2c3e50 !important;
                -webkit-text-fill-color: #2c3e50 !important;
                background: none !important;
                -webkit-background-clip: initial !important;
                background-clip: initial !important;
                margin-bottom: 15px !important;
                padding-bottom: 10px !important;
                border-bottom: 2px solid #e5e7eb !important;
                border-image: none !important;
            }

            .chart-title::before {
                font-size: 16px !important;
            }

            .chart-container {
                height: 360px !important;  /* å¢åŠ é«˜åº¦ */
                width: 100% !important;
                max-width: 100% !important;
                overflow: visible !important;
                position: relative !important;
            }

            /* ç¡®ä¿ECharts canvasä¸æº¢å‡º */
            .chart-container canvas {
                max-width: 100% !important;
                max-height: 100% !important;
                width: auto !important;
                height: auto !important;
            }

            /* æ‰“å°æ—¶è°ƒæ•´EChartså›¾è¡¨å†…è¾¹è·ï¼Œé˜²æ­¢å†…å®¹è¢«è£åˆ‡ */
            .chart-container > div {
                padding: 5px !important;
            }

            /* æ‰“å°æ—¶ç¼©å°å›¾è¡¨å­—ä½“ï¼Œè®©å†…å®¹æ›´ç´§å‡‘ */
            .chart-container text {
                font-size: 10px !important;
            }

            /* æ‰“å°æ—¶ä¼˜åŒ–å›¾ä¾‹æ ·å¼ */
            .chart-container .echarts-legend-item {
                font-size: 11px !important;
            }

            /* ç¡®ä¿ç©ºæ•°æ®æç¤ºä¸æ‰“å° */
            .loading,
            div[v-show="!hasData && !loading"] {
                display: none !important;
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats-cards {
                grid-template-columns: 1fr;
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-item {
                width: 100%;
            }
        }
    </style>
</head>
<body>
{% raw %}
    <div id="app">
        <div class="page-header">
            <h1 class="page-title">ğŸ“Š æ”¶è´¹æ•°æ®æŠ¥è¡¨</h1>
            <p class="page-subtitle">å¯è§†åŒ–å±•ç¤ºæ”¶è´¹ç»Ÿè®¡æ•°æ®ï¼Œæ”¯æŒå¤šç»´åº¦åˆ†æ</p>
        </div>

        <!-- ç­›é€‰åŒºåŸŸ -->
        <div class="filter-section">
            <div class="filter-row">
                <!-- åœ°åŒºé€‰æ‹© -->
                <div class="filter-item">
                    <span class="filter-label">é€‰æ‹©åœ°åŒºï¼š</span>
                    <el-select 
                        v-model="selectedCommunity" 
                        placeholder="è¯·é€‰æ‹©"
                        :disabled="isCommunityDisabled"
                        :clearable="!isCommunityDisabled"
                        style="width: 250px;">
                        <el-option
                            v-for="community in communities"
                            :key="community"
                            :label="community"
                            :value="community">
                        </el-option>
                    </el-select>
                </div>
                
                <div class="filter-item">
                    <span class="filter-label">æ—¥æœŸèŒƒå›´ï¼š</span>
                    <div class="date-input-wrapper">
                        <input 
                            type="text" 
                            id="startDate" 
                            class="datetime-input"
                            placeholder="å¼€å§‹æ—¥æœŸ"
                            readonly>
                    </div>
                    <span style="margin: 0 5px;">è‡³</span>
                    <div class="date-input-wrapper">
                        <input 
                            type="text" 
                            id="endDate" 
                            class="datetime-input"
                            placeholder="ç»“æŸæ—¥æœŸ"
                            readonly>
                    </div>
                </div>

                <div class="filter-item">
                    <span class="filter-label">ç»Ÿè®¡ç»´åº¦ï¼š</span>
                    <div class="dimension-tabs">
                        <div 
                            class="dimension-tab" 
                            :class="{active: dimension === 'day'}"
                            @click="dimension = 'day'">
                            æŒ‰å¤©
                        </div>
                        <div 
                            class="dimension-tab" 
                            :class="{active: dimension === 'week'}"
                            @click="dimension = 'week'">
                            æŒ‰å‘¨
                        </div>
                        <div 
                            class="dimension-tab" 
                            :class="{active: dimension === 'month'}"
                            @click="dimension = 'month'">
                            æŒ‰æœˆ
                        </div>
                    </div>
                </div>

                <el-button 
                    type="primary" 
                    @click="loadReportData"
                    :loading="loading">
                    æŸ¥è¯¢æŠ¥è¡¨
                </el-button>

                <el-button 
                    @click="printReport"
                    :disabled="!hasData">
                    æ‰“å°æŠ¥è¡¨
                </el-button>
            </div>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div v-if="loading" class="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">æ­£åœ¨åŠ è½½æŠ¥è¡¨æ•°æ®...</div>
        </div>

        <!-- æ•°æ®å±•ç¤º -->
        <div v-show="hasData && !loading">
            <!-- æ•°æ®æ¦‚è§ˆå¡ç‰‡ -->
            <div class="stats-cards">
                <div class="stat-card primary">
                    <div class="stat-icon">ğŸ“Š</div>
                    <div class="stat-label">æ€»ç¬”æ•°</div>
                    <div class="stat-value">[[ statsData.totalCount ]]</div>
                    <span class="stat-change up" v-if="statsData.countChange > 0">â†‘ [[ statsData.countChange ]]%</span>
                    <span class="stat-change down" v-else-if="statsData.countChange < 0">â†“ [[ Math.abs(statsData.countChange) ]]%</span>
                </div>

                <div class="stat-card success">
                    <div class="stat-icon">ğŸ’°</div>
                    <div class="stat-label">æ€»é‡‘é¢</div>
                    <div class="stat-value">Â¥[[ formatNumber(statsData.totalAmount) ]]</div>
                    <span class="stat-change up" v-if="statsData.amountChange > 0">â†‘ [[ statsData.amountChange ]]%</span>
                    <span class="stat-change down" v-else-if="statsData.amountChange < 0">â†“ [[ Math.abs(statsData.amountChange) ]]%</span>
                </div>

                <div class="stat-card warning">
                    <div class="stat-icon">ğŸ“ˆ</div>
                    <div class="stat-label">å¹³å‡é‡‘é¢</div>
                    <div class="stat-value">Â¥[[ formatNumber(statsData.avgAmount) ]]</div>
                </div>

                <div class="stat-card danger">
                    <div class="stat-icon">ğŸ†</div>
                    <div class="stat-label">æœ€é«˜å•ç¬”</div>
                    <div class="stat-value">Â¥[[ formatNumber(statsData.maxAmount) ]]</div>
                </div>
            </div>

            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="charts-grid">
                <!-- æ—¶é—´è¶‹åŠ¿å›¾ -->
                <div class="chart-card full-width">
                    <h3 class="chart-title">æ”¶è´¹è¶‹åŠ¿åˆ†æ</h3>
                    <div id="trendChart" class="chart-container"></div>
                </div>

                <!-- æ”¶æ¬¾æ–¹å¼åˆ†å¸ƒ -->
                <div class="chart-card">
                    <h3 class="chart-title">æ”¶æ¬¾æ–¹å¼åˆ†å¸ƒ</h3>
                    <div id="paymentChart" class="chart-container"></div>
                </div>

                <!-- æ”¶è´¹é¡¹ç›®ç»Ÿè®¡ -->
                <div class="chart-card">
                    <h3 class="chart-title">æ”¶è´¹é¡¹ç›®ç»Ÿè®¡</h3>
                    <div id="feeTypeChart" class="chart-container"></div>
                </div>
            </div>
        </div>

        <!-- ç©ºæ•°æ®æç¤º -->
        <div v-show="!hasData && !loading" style="text-align: center; padding: 60px; background: white; border-radius: 12px;">
            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“­</div>
            <div style="font-size: 16px; color: #6c757d;">è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´åç‚¹å‡»"æŸ¥è¯¢æŠ¥è¡¨"æŒ‰é’®</div>
        </div>
    </div>
{% endraw %}

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
        const { ElButton, ElMessage } = ElementPlus;

        const app = createApp({
            compilerOptions: {
                delimiters: ['[[', ']]']
            },
            setup() {
                const loading = ref(false);
                const dimension = ref('day');
                const hasData = ref(false);
                
                // åœ°åŒºé€‰æ‹©ç›¸å…³
                const communities = ref([]);  // å°åŒºåˆ—è¡¨
                const selectedCommunity = ref('');  // é€‰ä¸­çš„å°åŒº
                const userInfo = ref({  // ç”¨æˆ·ä¿¡æ¯
                    real_name: '',
                    role: '',
                    community: ''
                });
                
                // å°åŒºé€‰æ‹©æ˜¯å¦ç¦ç”¨ï¼šå°åŒºæ“ä½œå‘˜ä¸èƒ½é€‰æ‹©å…¶ä»–å°åŒº
                const isCommunityDisabled = computed(() => {
                    return userInfo.value.role === 'å°åŒºæ“ä½œå‘˜';
                });
                
                // ç»Ÿè®¡æ•°æ®
                const statsData = ref({
                    totalCount: 0,
                    totalAmount: 0,
                    avgAmount: 0,
                    maxAmount: 0,
                    countChange: 0,
                    amountChange: 0
                });

                // å›¾è¡¨æ•°æ®
                const trendData = ref({ labels: [], counts: [], amounts: [] });
                const paymentData = ref([]);
                const feeTypeData = ref([]);

                // æ—¥æœŸé€‰æ‹©å™¨
                let startDatePicker = null;
                let endDatePicker = null;

                // è·å–Token
                const getToken = () => {
                    return sessionStorage.getItem('token');
                };

                // è·å–ç”¨æˆ·ä¿¡æ¯
                const loadUserInfo = () => {
                    const userData = sessionStorage.getItem('user');
                    if (userData) {
                        const user = JSON.parse(userData);
                        userInfo.value = {
                            real_name: user.real_name || user.username,
                            role: user.role,
                            community: user.community || ''
                        };
                        
                        // å¦‚æœæ˜¯å°åŒºæ“ä½œå‘˜ï¼Œé»˜è®¤è®¾ç½®å°åŒºä¸”ä¸å¯æ›´æ”¹
                        if (user.role === 'å°åŒºæ“ä½œå‘˜' && user.community) {
                            selectedCommunity.value = user.community;
                        }
                    }
                };

                // åŠ è½½å°åŒºåˆ—è¡¨
                const loadCommunities = async () => {
                    try {
                        const token = getToken();
                        const response = await axios.get('/api/communities', {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (response.data.status === 'success') {
                            communities.value = response.data.data;
                        } else {
                            ElMessage.error('åŠ è½½å°åŒºåˆ—è¡¨å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('åŠ è½½å°åŒºåˆ—è¡¨å¤±è´¥:', error);
                    }
                };

                // è·å–é€‚ç”¨äºæ‰“å°çš„gridé…ç½®
                const getPrintSafeGrid = () => {
                    // ä¸ºæ‰“å°ç•™å‡ºæ›´å¤šè¾¹è·ç©ºé—´
                    return {
                        left: '8%',
                        right: '8%',
                        bottom: '12%',
                        top: '18%',
                        containLabel: true
                    };
                };

                // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨ï¼ˆå¸¦åº“åŠ è½½æ£€æµ‹ï¼‰
                let flatpickrLoadWarned = false;
                const initDatePickers = () => {
                    // æ£€æŸ¥ flatpickr æ˜¯å¦å·²åŠ è½½
                    if (typeof flatpickr === 'undefined') {
                        if (!flatpickrLoadWarned) {
                            console.warn('flatpickr æœªåŠ è½½ï¼Œç­‰å¾…åŠ è½½...');
                            flatpickrLoadWarned = true;
                        }
                        setTimeout(initDatePickers, 100);
                        return;
                    }
                    
                    nextTick(() => {
                        startDatePicker = flatpickr("#startDate", {
                            locale: "zh",
                            dateFormat: "Y-m-d",
                            defaultDate: new Date(new Date().setDate(new Date().getDate() - 30)),
                            onChange: function(selectedDates, dateStr) {
                                if (endDatePicker && selectedDates.length > 0) {
                                    endDatePicker.set('minDate', selectedDates[0]);
                                }
                            }
                        });

                        endDatePicker = flatpickr("#endDate", {
                            locale: "zh",
                            dateFormat: "Y-m-d",
                            defaultDate: new Date(),
                            onChange: function(selectedDates, dateStr) {
                                if (startDatePicker && selectedDates.length > 0) {
                                    startDatePicker.set('maxDate', selectedDates[0]);
                                }
                            }
                        });
                    });
                };

                // åŠ è½½æŠ¥è¡¨æ•°æ®
                const loadReportData = async () => {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    console.log('æŸ¥è¯¢æŠ¥è¡¨æ•°æ® - æ—¥æœŸèŒƒå›´:', { startDate, endDate });

                    if (!startDate || !endDate) {
                        ElMessage.warning('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
                        return;
                    }

                    loading.value = true;
                    
                    try {
                        const token = getToken();
                        
                        console.log('å‘é€APIè¯·æ±‚å‚æ•°:', {
                            start_date: startDate,
                            end_date: endDate,
                            dimension: dimension.value,
                            community: selectedCommunity.value
                        });
                        
                        // æ„å»ºè¯·æ±‚å‚æ•°
                        const baseParams = {
                            start_date: startDate,
                            end_date: endDate
                        };
                        
                        // å¦‚æœé€‰æ‹©äº†å°åŒºï¼Œæ·»åŠ communityå‚æ•°
                        if (selectedCommunity.value) {
                            baseParams.community = selectedCommunity.value;
                        }
                        
                        // å¹¶è¡Œè¯·æ±‚æ‰€æœ‰æ•°æ®
                        const [timeStats, paymentStats, feeTypeStats, overviewStats] = await Promise.all([
                            axios.get('/api/reports/time-stats', {
                                headers: { 'Authorization': `Bearer ${token}` },
                                params: { ...baseParams, dimension: dimension.value }
                            }),
                            axios.get('/api/reports/payment-stats', {
                                headers: { 'Authorization': `Bearer ${token}` },
                                params: baseParams
                            }),
                            axios.get('/api/reports/fee-type-stats', {
                                headers: { 'Authorization': `Bearer ${token}` },
                                params: baseParams
                            }),
                            axios.get('/api/reports/overview-stats', {
                                headers: { 'Authorization': `Bearer ${token}` },
                                params: baseParams
                            })
                        ]);

                        // æ›´æ–°æ•°æ®
                        trendData.value = timeStats.data.data;
                        paymentData.value = paymentStats.data.data;
                        feeTypeData.value = feeTypeStats.data.data;
                        statsData.value = overviewStats.data.data;

                        console.log('æŠ¥è¡¨æ•°æ®åŠ è½½æˆåŠŸ:', {
                            dimension: dimension.value,
                            labels: trendData.value.labels,
                            counts: trendData.value.counts,
                            amounts: trendData.value.amounts
                        });

                        hasData.value = true;

                        // ç­‰å¾…DOMæ›´æ–°åç»˜åˆ¶å›¾è¡¨
                        nextTick(() => {
                            console.log('å¼€å§‹ç»˜åˆ¶å›¾è¡¨...');
                            drawTrendChart();
                            drawPaymentChart();
                            drawFeeTypeChart();
                        });

                        ElMessage.success('æŠ¥è¡¨æ•°æ®åŠ è½½æˆåŠŸ');
                    } catch (error) {
                        console.error('åŠ è½½æŠ¥è¡¨æ•°æ®å¤±è´¥:', error);
                        if (error.response?.status === 401) {
                            ElMessage.error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                            setTimeout(() => {
                                window.location.href = '/login';
                            }, 1500);
                        } else {
                            ElMessage.error('åŠ è½½æŠ¥è¡¨æ•°æ®å¤±è´¥');
                        }
                    } finally {
                        loading.value = false;
                    }
                };

                // ç»˜åˆ¶æ—¶é—´è¶‹åŠ¿å›¾ï¼ˆå¸¦echartsåŠ è½½æ£€æµ‹ï¼‰
                let echartsLoadWarned = false;
                const drawTrendChart = () => {
                    // æ£€æŸ¥ echarts æ˜¯å¦å·²åŠ è½½
                    if (typeof echarts === 'undefined') {
                        if (!echartsLoadWarned) {
                            console.warn('echarts æœªåŠ è½½ï¼Œç­‰å¾…åŠ è½½...');
                            echartsLoadWarned = true;
                        }
                        setTimeout(drawTrendChart, 100);
                        return;
                    }
                    
                    console.log('ç»˜åˆ¶æ—¶é—´è¶‹åŠ¿å›¾, æ•°æ®ç‚¹æ•°é‡:', trendData.value.labels.length);
                    const chartDom = document.getElementById('trendChart');
                    if (!chartDom) {
                        console.error('å›¾è¡¨å®¹å™¨ä¸å­˜åœ¨');
                        return;
                    }
                    
                    // å¦‚æœå›¾è¡¨å®ä¾‹å·²å­˜åœ¨ï¼Œå…ˆé”€æ¯
                    const existingChart = echarts.getInstanceByDom(chartDom);
                    if (existingChart) {
                        existingChart.dispose();
                    }
                    
                    const chart = echarts.init(chartDom);
                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { 
                                type: 'cross',
                                crossStyle: {
                                    color: '#999'
                                }
                            },
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            textStyle: {
                                color: '#333',
                                fontSize: 14
                            },
                            padding: 15,
                            extraCssText: 'box-shadow: 0 4px 20px rgba(0,0,0,0.15); border-radius: 8px;'
                        },
                        legend: {
                            data: ['ç¬”æ•°', 'é‡‘é¢'],
                            top: 5,
                            right: 20,
                            textStyle: {
                                fontSize: 14,
                                fontWeight: 600
                            },
                            icon: 'roundRect',
                            itemWidth: 30,
                            itemHeight: 16,
                            itemGap: 20
                        },
                        grid: {
                            left: '5%',
                            right: '6%',
                            bottom: '12%',  /* å¢åŠ åº•éƒ¨è¾¹è· */
                            top: '20%',     /* å¢åŠ é¡¶éƒ¨è¾¹è· */
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            data: trendData.value.labels,
                            axisLabel: { 
                                rotate: 45,
                                color: '#666',
                                fontSize: 12,
                                fontWeight: 500
                            },
                            axisLine: {
                                lineStyle: {
                                    color: '#e5e7eb',
                                    width: 2
                                }
                            },
                            axisTick: {
                                show: false
                            }
                        },
                        yAxis: [
                            {
                                type: 'value',
                                name: 'ç¬”æ•°',
                                position: 'left',
                                nameTextStyle: {
                                    color: '#667eea',
                                    fontSize: 14,
                                    fontWeight: 600,
                                    padding: [0, 0, 0, 20]
                                },
                                axisLabel: {
                                    color: '#666',
                                    fontSize: 12
                                },
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: '#667eea',
                                        width: 2
                                    }
                                },
                                splitLine: {
                                    lineStyle: {
                                        color: '#f0f0f0',
                                        type: 'dashed'
                                    }
                                }
                            },
                            {
                                type: 'value',
                                name: 'é‡‘é¢(å…ƒ)',
                                position: 'right',
                                nameTextStyle: {
                                    color: '#67C23A',
                                    fontSize: 14,
                                    fontWeight: 600,
                                    padding: [0, 20, 0, 0]
                                },
                                axisLabel: {
                                    color: '#666',
                                    fontSize: 12,
                                    formatter: '{value}'
                                },
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: '#67C23A',
                                        width: 2
                                    }
                                },
                                splitLine: {
                                    show: false
                                }
                            }
                        ],
                        series: [
                            {
                                name: 'ç¬”æ•°',
                                type: 'bar',
                                data: trendData.value.counts,
                                barWidth: '40%',
                                itemStyle: {
                                    borderRadius: [8, 8, 0, 0],
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        { offset: 0, color: '#667eea' },
                                        { offset: 1, color: '#764ba2' }
                                    ])
                                },
                                emphasis: {
                                    itemStyle: {
                                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                            { offset: 0, color: '#5a6fd8' },
                                            { offset: 1, color: '#6a4190' }
                                        ])
                                    }
                                },
                                label: {
                                    show: true,
                                    position: 'top',
                                    color: '#667eea',
                                    fontSize: 11,
                                    fontWeight: 600
                                }
                            },
                            {
                                name: 'é‡‘é¢',
                                type: 'line',
                                yAxisIndex: 1,
                                data: trendData.value.amounts,
                                smooth: true,
                                symbol: 'circle',
                                symbolSize: 8,
                                lineStyle: {
                                    width: 3,
                                    color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                        { offset: 0, color: '#67C23A' },
                                        { offset: 1, color: '#85CE61' }
                                    ])
                                },
                                itemStyle: { 
                                    color: '#67C23A',
                                    borderWidth: 2,
                                    borderColor: '#fff'
                                },
                                areaStyle: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        { offset: 0, color: 'rgba(103, 194, 58, 0.4)' },
                                        { offset: 1, color: 'rgba(103, 194, 58, 0.05)' }
                                    ])
                                },
                                emphasis: {
                                    focus: 'series'
                                }
                            }
                        ],
                        animationDuration: 1500,
                        animationEasing: 'cubicOut'
                    };
                    chart.setOption(option);
                    
                    // å“åº”å¼
                    window.addEventListener('resize', () => chart.resize());
                };

                // ç»˜åˆ¶æ”¶æ¬¾æ–¹å¼å›¾ï¼ˆå¸¦echartsåŠ è½½æ£€æµ‹ï¼‰
                const drawPaymentChart = () => {
                    // æ£€æŸ¥ echarts æ˜¯å¦å·²åŠ è½½
                    if (typeof echarts === 'undefined') {
                        if (!echartsLoadWarned) {
                            console.warn('echarts æœªåŠ è½½ï¼Œç­‰å¾…åŠ è½½...');
                            echartsLoadWarned = true;
                        }
                        setTimeout(drawPaymentChart, 100);
                        return;
                    }
                    
                    const chartDom = document.getElementById('paymentChart');
                    if (!chartDom) {
                        console.error('æ”¶æ¬¾æ–¹å¼å›¾è¡¨å®¹å™¨ä¸å­˜åœ¨');
                        return;
                    }
                    
                    // å¦‚æœå›¾è¡¨å®ä¾‹å·²å­˜åœ¨ï¼Œå…ˆé”€æ¯
                    const existingChart = echarts.getInstanceByDom(chartDom);
                    if (existingChart) {
                        existingChart.dispose();
                    }
                    
                    const chart = echarts.init(chartDom);
                    const option = {
                        tooltip: {
                            trigger: 'item',
                            formatter: '{b}<br/>ç¬”æ•°: {c} ({d}%)',
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            textStyle: {
                                color: '#333',
                                fontSize: 14
                            },
                            padding: 15,
                            extraCssText: 'box-shadow: 0 4px 20px rgba(0,0,0,0.15); border-radius: 8px;'
                        },
                        legend: {
                            orient: 'vertical',
                            left: 'left',
                            top: 'middle',
                            textStyle: {
                                fontSize: 13,
                                fontWeight: 500
                            },
                            icon: 'circle',
                            itemWidth: 12,
                            itemHeight: 12,
                            itemGap: 15,
                            formatter: function(name) {
                                const item = paymentData.value.find(d => d.name === name);
                                return `${name}  ${item ? item.count : 0}ç¬”`;
                            }
                        },
                        series: [
                            {
                                type: 'pie',
                                radius: ['45%', '75%'],
                                center: ['60%', '50%'],
                                avoidLabelOverlap: false,
                                itemStyle: {
                                    borderRadius: 12,
                                    borderColor: '#fff',
                                    borderWidth: 3,
                                    shadowBlur: 10,
                                    shadowColor: 'rgba(0, 0, 0, 0.1)'
                                },
                                label: {
                                    show: true,
                                    position: 'outside',
                                    formatter: '{d}%',
                                    fontSize: 13,
                                    fontWeight: 600,
                                    color: '#333'
                                },
                                labelLine: {
                                    show: true,
                                    length: 15,
                                    length2: 10,
                                    smooth: true,
                                    lineStyle: {
                                        width: 2
                                    }
                                },
                                emphasis: {
                                    itemStyle: {
                                        shadowBlur: 20,
                                        shadowOffsetX: 0,
                                        shadowColor: 'rgba(0, 0, 0, 0.3)'
                                    },
                                    label: {
                                        show: true,
                                        fontSize: 16,
                                        fontWeight: 700
                                    },
                                    scaleSize: 10
                                },
                                data: paymentData.value.map((item, index) => ({
                                    name: item.name,
                                    value: item.count
                                })),
                                color: [
                                    new echarts.graphic.LinearGradient(0, 0, 1, 1, [
                                        { offset: 0, color: '#667eea' },
                                        { offset: 1, color: '#764ba2' }
                                    ]),
                                    new echarts.graphic.LinearGradient(0, 0, 1, 1, [
                                        { offset: 0, color: '#67C23A' },
                                        { offset: 1, color: '#85CE61' }
                                    ]),
                                    new echarts.graphic.LinearGradient(0, 0, 1, 1, [
                                        { offset: 0, color: '#E6A23C' },
                                        { offset: 1, color: '#EEBE77' }
                                    ]),
                                    new echarts.graphic.LinearGradient(0, 0, 1, 1, [
                                        { offset: 0, color: '#F56C6C' },
                                        { offset: 1, color: '#F78989' }
                                    ])
                                ]
                            }
                        ],
                        animationDuration: 1500,
                        animationEasing: 'elasticOut'
                    };
                    chart.setOption(option);
                    window.addEventListener('resize', () => chart.resize());
                };

                // ç»˜åˆ¶æ”¶è´¹é¡¹ç›®å›¾ï¼ˆå¸¦echartsåŠ è½½æ£€æµ‹ï¼‰
                const drawFeeTypeChart = () => {
                    // æ£€æŸ¥ echarts æ˜¯å¦å·²åŠ è½½
                    if (typeof echarts === 'undefined') {
                        if (!echartsLoadWarned) {
                            console.warn('echarts æœªåŠ è½½ï¼Œç­‰å¾…åŠ è½½...');
                            echartsLoadWarned = true;
                        }
                        setTimeout(drawFeeTypeChart, 100);
                        return;
                    }
                    
                    const chartDom = document.getElementById('feeTypeChart');
                    if (!chartDom) {
                        console.error('æ”¶è´¹é¡¹ç›®å›¾è¡¨å®¹å™¨ä¸å­˜åœ¨');
                        return;
                    }
                    
                    // å¦‚æœå›¾è¡¨å®ä¾‹å·²å­˜åœ¨ï¼Œå…ˆé”€æ¯
                    const existingChart = echarts.getInstanceByDom(chartDom);
                    if (existingChart) {
                        existingChart.dispose();
                    }
                    
                    const chart = echarts.init(chartDom);
                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' },
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            borderColor: '#667eea',
                            borderWidth: 2,
                            textStyle: {
                                color: '#333',
                                fontSize: 14
                            },
                            padding: 15,
                            extraCssText: 'box-shadow: 0 4px 20px rgba(0,0,0,0.15); border-radius: 8px;'
                        },
                        legend: {
                            data: ['ç¬”æ•°', 'é‡‘é¢'],
                            top: 5,
                            right: 20,
                            textStyle: {
                                fontSize: 14,
                                fontWeight: 600
                            },
                            icon: 'roundRect',
                            itemWidth: 30,
                            itemHeight: 16,
                            itemGap: 20
                        },
                        grid: {
                            left: '5%',
                            right: '6%',
                            bottom: '8%',   /* å¢åŠ åº•éƒ¨è¾¹è· */
                            top: '20%',     /* å¢åŠ é¡¶éƒ¨è¾¹è· */
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            data: feeTypeData.value.map(item => item.name),
                            axisLabel: {
                                color: '#666',
                                fontSize: 12,
                                fontWeight: 500,
                                interval: 0
                            },
                            axisLine: {
                                lineStyle: {
                                    color: '#e5e7eb',
                                    width: 2
                                }
                            },
                            axisTick: {
                                show: false
                            }
                        },
                        yAxis: [
                            {
                                type: 'value',
                                name: 'ç¬”æ•°',
                                nameTextStyle: {
                                    color: '#409EFF',
                                    fontSize: 14,
                                    fontWeight: 600,
                                    padding: [0, 0, 0, 20]
                                },
                                axisLabel: {
                                    color: '#666',
                                    fontSize: 12
                                },
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: '#409EFF',
                                        width: 2
                                    }
                                },
                                splitLine: {
                                    lineStyle: {
                                        color: '#f0f0f0',
                                        type: 'dashed'
                                    }
                                }
                            },
                            {
                                type: 'value',
                                name: 'é‡‘é¢(å…ƒ)',
                                position: 'right',
                                nameTextStyle: {
                                    color: '#67C23A',
                                    fontSize: 14,
                                    fontWeight: 600,
                                    padding: [0, 20, 0, 0]
                                },
                                axisLabel: {
                                    color: '#666',
                                    fontSize: 12
                                },
                                axisLine: {
                                    show: true,
                                    lineStyle: {
                                        color: '#67C23A',
                                        width: 2
                                    }
                                },
                                splitLine: {
                                    show: false
                                }
                            }
                        ],
                        series: [
                            {
                                name: 'ç¬”æ•°',
                                type: 'bar',
                                data: feeTypeData.value.map(item => item.count),
                                barWidth: '35%',
                                itemStyle: { 
                                    borderRadius: [8, 8, 0, 0],
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        { offset: 0, color: '#409EFF' },
                                        { offset: 1, color: '#66b1ff' }
                                    ])
                                },
                                emphasis: {
                                    itemStyle: {
                                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                            { offset: 0, color: '#1890ff' },
                                            { offset: 1, color: '#409EFF' }
                                        ])
                                    }
                                },
                                label: {
                                    show: true,
                                    position: 'top',
                                    color: '#409EFF',
                                    fontSize: 11,
                                    fontWeight: 600
                                }
                            },
                            {
                                name: 'é‡‘é¢',
                                type: 'bar',
                                yAxisIndex: 1,
                                data: feeTypeData.value.map(item => item.amount),
                                barWidth: '35%',
                                itemStyle: { 
                                    borderRadius: [8, 8, 0, 0],
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        { offset: 0, color: '#67C23A' },
                                        { offset: 1, color: '#85CE61' }
                                    ])
                                },
                                emphasis: {
                                    itemStyle: {
                                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                            { offset: 0, color: '#529b2e' },
                                            { offset: 1, color: '#67C23A' }
                                        ])
                                    }
                                },
                                label: {
                                    show: true,
                                    position: 'top',
                                    color: '#67C23A',
                                    fontSize: 11,
                                    fontWeight: 600
                                }
                            }
                        ],
                        animationDuration: 1500,
                        animationEasing: 'elasticOut'
                    };
                    chart.setOption(option);
                    window.addEventListener('resize', () => chart.resize());
                };

                // æ‰“å°æŠ¥è¡¨
                const printReport = () => {
                    // æ‰“å°å‰è°ƒæ•´æ‰€æœ‰å›¾è¡¨å°ºå¯¸
                    setTimeout(() => {
                        // è·å–æ‰€æœ‰EChartså®ä¾‹å¹¶è°ƒæ•´å°ºå¯¸
                        const chartDoms = [
                            document.getElementById('trendChart'),
                            document.getElementById('paymentChart'),
                            document.getElementById('feeTypeChart')
                        ];
                        
                        chartDoms.forEach(dom => {
                            if (dom) {
                                const chartInstance = echarts.getInstanceByDom(dom);
                                if (chartInstance) {
                                    chartInstance.resize();
                                }
                            }
                        });
                        
                        // ç¨å¾®å»¶è¿Ÿåæ‰“å°ï¼Œç¡®ä¿å›¾è¡¨è°ƒæ•´å®Œæˆ
                        setTimeout(() => {
                            window.print();
                        }, 300);
                    }, 100);
                };

                // æ ¼å¼åŒ–æ•°å­—
                const formatNumber = (num) => {
                    if (!num) return '0';
                    return parseFloat(num).toLocaleString('zh-CN', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                };

                onMounted(() => {
                    loadUserInfo();  // åŠ è½½ç”¨æˆ·ä¿¡æ¯
                    loadCommunities();  // åŠ è½½å°åŒºåˆ—è¡¨
                    initDatePickers();
                    
                    // ç›‘å¬æ‰“å°äº‹ä»¶ï¼Œåœ¨æ‰“å°å‰åè°ƒæ•´å›¾è¡¨
                    window.addEventListener('beforeprint', () => {
                        console.log('å‡†å¤‡æ‰“å°ï¼Œè°ƒæ•´å›¾è¡¨å°ºå¯¸...');
                        const chartDoms = [
                            document.getElementById('trendChart'),
                            document.getElementById('paymentChart'),
                            document.getElementById('feeTypeChart')
                        ];
                        
                        chartDoms.forEach(dom => {
                            if (dom) {
                                const chartInstance = echarts.getInstanceByDom(dom);
                                if (chartInstance) {
                                    chartInstance.resize();
                                }
                            }
                        });
                    });
                    
                    window.addEventListener('afterprint', () => {
                        console.log('æ‰“å°å®Œæˆï¼Œæ¢å¤å›¾è¡¨å°ºå¯¸...');
                        const chartDoms = [
                            document.getElementById('trendChart'),
                            document.getElementById('paymentChart'),
                            document.getElementById('feeTypeChart')
                        ];
                        
                        chartDoms.forEach(dom => {
                            if (dom) {
                                const chartInstance = echarts.getInstanceByDom(dom);
                                if (chartInstance) {
                                    chartInstance.resize();
                                }
                            }
                        });
                    });
                });

                // ç›‘å¬ç»Ÿè®¡ç»´åº¦å˜åŒ–ï¼Œè‡ªåŠ¨é‡æ–°åŠ è½½æ•°æ®
                watch(dimension, (newVal, oldVal) => {
                    console.log('ç»Ÿè®¡ç»´åº¦å˜åŒ–:', oldVal, '->', newVal);
                    if (hasData.value && newVal !== oldVal) {
                        loadReportData();
                    }
                });

                return {
                    loading,
                    dimension,
                    hasData,
                    statsData,
                    loadReportData,
                    printReport,
                    formatNumber,
                    // åœ°åŒºé€‰æ‹©ç›¸å…³
                    communities,
                    selectedCommunity,
                    isCommunityDisabled
                };
            }
        });

        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>
