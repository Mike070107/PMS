<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公寓物业收费系统 - 工作台</title>
    <!-- 引入 Element Plus 样式 -->
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/lib/element-plus.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 引入 Vue 3 和 Element Plus -->
    <script src="/static/lib/vue.global.js"></script>
    <script src="/static/lib/element-plus.full.js"></script>
    <script src="/static/lib/element-plus-icons.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 220px;
            background-color: #001529;
            color: white;
            padding: 20px 0;
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        .sidebar-title {
            font-size: 18px;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }
        
        .user-info {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .nav-item:hover,
        .nav-item.active {
            background-color: #1890ff;
        }
        
        .nav-item i {
            margin-right: 10px;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .header-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        .workbench-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .address-selector {
            margin-bottom: 30px;
        }
        
        .fee-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .fee-table {
            width: 100%;
            margin-bottom: 30px;
            border-collapse: collapse;
        }
        
        .fee-table th,
        .fee-table td {
            border: 1px solid #e8e8e8;
            padding: 12px;
            text-align: center;
        }
        
        .fee-table th {
            background-color: #fafafa;
            font-weight: bold;
        }
        
        .fee-table .el-input {
            width: 120px;
        }
        
        .summary-section {
            background: #fafafa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 30px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .empty-table {
            text-align: center;
            color: #999;
            padding: 40px;
        }
        
        .fee-item-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        /* 地址选择器样式 */
        .address-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .address-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .field-label {
            font-size: 14px;
            color: #606266;
            font-weight: 500;
            margin-bottom: 4px;
        }

        /* 错误提示样式 */
        .phone-error {
            color: #f56c6c;
            font-size: 12px;
            margin-top: 5px;
        }

        /* 按钮禁用状态样式 */
        .el-button.is-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* 费用表格样式调整 */
        .fee-table th:nth-child(6),
        .fee-table td:nth-child(6) {
            width: 150px;
        }

        /* 汇总信息区块样式 */
        .summary-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        /* 收款方式行样式 */
        .payment-method-row {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .payment-label-container {
            min-width: 80px;
        }

        .payment-label {
            font-weight: 500;
            color: #606266;
            font-size: 14px;
        }

        .payment-options-container {
            flex: 1;
        }

        .payment-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .payment-options {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}

.payment-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 120px;
    height: 100px;
    border: 2px solid #e4e7ed;
    border-radius: 8px;
    padding: 15px 10px;
    background-color: #fff;
    transition: all 0.3s ease;
    position: relative;
}

.payment-option:hover {
    border-color: #409eff;
    box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.payment-option.selected {
    border-color: #409eff;
    background-color: #ecf5ff;
    box-shadow: 0 2px 12px 0 rgba(64, 158, 255, 0.2);
}

.payment-icon {
    font-size: 36px;
    margin-bottom: 8px;
}

.wechat-icon {
    color: #07c160; /* 微信绿色 */
}

.alipay-icon {
    color: #1677ff; /* 支付宝蓝色 */
}

.cash-icon {
    color: #f56c6c; /* 现金红色 */
}

.payment-text {
    font-size: 14px;
    font-weight: 500;
    color: #606266;
}

.payment-check {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 20px;
    height: 20px;
    background-color: #409eff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
}

/* 备注文本框左对齐 */
.summary-row .el-textarea__inner {
    text-align: left;
    font-family: inherit;
    font-size: 14px;
    resize: vertical;
    min-height: 80px;
}

/* 总计金额样式 */
.total-amount {
    font-size: 20px;
    font-weight: bold;
    color: #303133;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 2px solid #e8e8e8;
}

/* 响应式调整 */
@media (max-width: 768px) {
    .payment-options {
        justify-content: flex-start;
    }
    
    .payment-option {
        width: 100px;
        height: 90px;
    }
    
    .payment-icon {
        font-size: 30px;
    }
    
    .summary-row {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .summary-row .el-textarea {
        width: 100%;
        max-width: 100% !important;
    }
}




    </style>
</head>
<body>
    <div id="app">
        <div class="app-container">
            <!-- 侧边栏 -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">物业收费系统</div>
                    <div class="user-info">
                        [[ user.real_name ]] <br> <!-- 使用真实姓名 -->
                        [[ user.community ]] <!-- 所属小区 -->
                        <span v-if="user.role" style="display: block; font-size: 11px; color: #aaa; margin-top: 2px;">
                            [[ user.role ]] <!-- 显示用户角色 -->
                        </span>
                    </div>
                </div>
                <ul class="nav-menu">
                    <li class="nav-item active" @click="currentPage = 'workbench'">
                        <i class="el-icon-s-home"></i> 收费工作台
                    </li>
                    <li class="nav-item" @click="currentPage = 'query'">
                        <i class="el-icon-search"></i> 订单查询
                    </li>
                    <li class="nav-item" @click="logout">
                        <i class="el-icon-switch-button"></i> 退出登录
                    </li>
                </ul>
            </div>
            
            <!-- 主内容区 -->
            <div class="main-content">
                <!-- 收费工作台页面 -->
                <div v-if="currentPage === 'workbench'">
                    <div class="header">
                        <div class="header-title">收费工作台</div>
                    </div>
                    
                    <div class="workbench-container">
                        <!-- 地址选择 -->
                        <div class="address-selector">
                            <div class="section-title">1. 选择地址</div>
                            
                            <div class="address-row">
                                <!-- 楼栋选择 -->
                                <div class="address-field">
                                    <div class="field-label">楼栋</div>
                                    <el-select 
                                        v-model="selectedBuilding" 
                                        placeholder="请选择" 
                                        style="width: 150px;"
                                        @change="onBuildingChange"
                                        clearable>
                                        <el-option
                                            v-for="building in buildings"
                                            :key="building"
                                            :label="building"
                                            :value="building">
                                        </el-option>
                                    </el-select>
                                </div>
                                
                                <!-- 房间选择 -->
                                <div class="address-field">
                                    <div class="field-label">房间</div>
                                    <el-select 
                                        v-model="selectedRoomId" 
                                        :placeholder="selectedBuilding ? '请选择' : '先选楼栋'" 
                                        style="width: 150px;"
                                        @change="onRoomChange"
                                        :disabled="!selectedBuilding"
                                        clearable>
                                        <el-option
                                            v-for="room in rooms"
                                            :key="room.id"
                                            :label="room.room"
                                            :value="room.id">
                                        </el-option>
                                    </el-select>
                                </div>
                                
                                <!-- 姓名输入 -->
                                <div class="address-field">
                                    <div class="field-label">姓名</div>
                                    <el-input 
                                        v-model="residentName" 
                                        placeholder="请输入" 
                                        style="width: 160px;"
                                        :maxlength="10"
                                        show-word-limit>
                                    </el-input>
                                </div>
                                
                                <!-- 手机号输入 -->
                                <div class="address-field">
                                    <div class="field-label">手机号</div>
                                    <el-input 
                                        v-model="residentPhone" 
                                        placeholder="请输入" 
                                        style="width: 190px;"
                                        :maxlength="11"
                                        @input="validatePhone">
                                    </el-input>
                                </div>
                            </div>
                            
                            <!-- 错误提示 -->
                            <div v-if="phoneError" class="phone-error">
                                [[ phoneError ]]
                            </div>
                        </div>
                        
                        <!-- 费用项目 -->
                        <div class="fee-section">
                            <div class="section-title">2. 添加收费项目</div>
                            <div class="fee-buttons">
                                <el-button 
                                    type="primary" 
                                    size="default" 
                                    @click="addFeeItem('electricity')" 
                                    :disabled="!selectedRoomId || buttonDisabled.electricity"
                                    :title="buttonDisabled.electricity ? '电费已添加或未选择地址' : '添加电费'">
                                    <i class="el-icon-lightning"></i> 添加电费
                                </el-button>
                                <el-button 
                                    type="primary" 
                                    size="default" 
                                    @click="addFeeItem('coldWater')" 
                                    :disabled="!selectedRoomId || buttonDisabled.coldWater"
                                    :title="buttonDisabled.coldWater ? '冷水费已添加或未选择地址' : '添加冷水费'">
                                    <i class="el-icon-water-drop"></i> 添加冷水费
                                </el-button>
                                <el-button 
                                    type="primary" 
                                    size="default" 
                                    @click="addFeeItem('hotWater')" 
                                    :disabled="!selectedRoomId || buttonDisabled.hotWater"
                                    :title="buttonDisabled.hotWater ? '热水费已添加或未选择地址' : '添加热水费'">
                                    <i class="el-icon-hot-water"></i> 添加热水费
                                </el-button>
                                <el-button 
                                    type="primary" 
                                    size="default" 
                                    @click="addFeeItem('network')" 
                                    :disabled="!selectedRoomId || buttonDisabled.network"
                                    :title="buttonDisabled.network ? '网费已添加或未选择地址' : '添加网费'">
                                    <i class="el-icon-monitor"></i> 添加网费
                                </el-button>
                                <el-button 
                                    type="primary" 
                                    size="default" 
                                    @click="addFeeItem('parking')" 
                                    :disabled="!selectedRoomId || buttonDisabled.parking"
                                    :title="buttonDisabled.parking ? '停车费已添加或未选择地址' : '添加停车费'">
                                    <i class="el-icon-truck"></i> 添加停车费
                                </el-button>
                            </div>
                            
                            <!-- 费用表格 -->
                            <table class="fee-table" v-if="feeItems.length > 0">
                                <thead>
                                    <tr>
                                        <th width="150">项目名称</th>
                                        <th width="100">单位</th>
                                        <th width="120">数量</th>
                                        <th width="120">单价（元）</th>
                                        <th width="120">金额（元）</th>
                                        <!-- 新增：车牌号列 -->
                                        <th width="150">车牌号</th>
                                        <th width="80">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(item, index) in feeItems" :key="index">
                                        <td>[[ getFeeTypeName(item.type) ]]</td>
                                        <td>[[ getFeeUnit(item.type) ]]</td>
                                        <td>
                                            <el-input-number
                                                v-model="item.quantity"
                                                :min="0"
                                                :step="item.type === 'network' || item.type === 'parking' ? 1 : 0.1"
                                                @change="updateItemAmount(index)"
                                                size="small">
                                            </el-input-number>
                                        </td>
                                        <td>
                                            <el-input-number
                                                v-model="item.unitPrice"
                                                :min="0"
                                                :step="0.1"
                                                @change="updateItemAmount(index)"
                                                size="small">
                                            </el-input-number>
                                        </td>
                                        <td>
                                            <el-input v-model="item.amount" readonly>
                                                <template #append>元</template>
                                            </el-input>
                                        </td>
                                        <!-- 新增：车牌号输入框（仅停车费显示） -->
                                        <td>
                                            <el-input 
                                                v-if="item.type === 'parking'" 
                                                v-model="item.carPlate" 
                                                placeholder="请输入车牌号"
                                                size="small"
                                                style="width: 120px;">
                                            </el-input>
                                            <span v-else style="color: #999;">-</span>
                                        </td>
                                        <td>
                                            <div class="fee-item-actions">
                                                <el-button 
                                                    type="danger" 
                                                    size="small" 
                                                    @click="removeFeeItem(index)" 
                                                    circle
                                                    title="删除此项">
                                                    <i class="el-icon-delete"></i>
                                                </el-button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <div v-else class="empty-table">
                                <i class="el-icon-document" style="font-size: 48px; color: #ccc; margin-bottom: 10px;"></i>
                                <p>暂无收费项目，请点击上方按钮添加</p>
                            </div>
                        </div>
                        
                        <!-- 汇总信息 -->
<!-- 汇总信息 -->
<div class="summary-section">
    <div class="section-title">3. 汇总信息</div>
    
    <!-- 收款方式 - 可勾选的图标按钮 -->
    <div class="summary-row" style="margin-bottom: 20px;">
        <span style="font-weight: 500; color: #606266; margin-right: 15px; min-width: 70px;">收款方式：</span>
        <div class="payment-options" style="display: flex; gap: 15px; align-items: center;">
            <!-- 微信支付 -->
            <div class="payment-option" 
                 :class="{ 'selected': paymentMethod === '微信' }" 
                 @click="selectPaymentMethod('微信')"
                 style="cursor: pointer;">
                <div class="payment-icon wechat-icon">
                    <i class="fab fa-weixin"></i>
                </div>
                <div class="payment-text">微信</div>
                <div class="payment-check" v-if="paymentMethod === '微信'">
                    <i class="el-icon-check"></i>
                </div>
            </div>
            
            <!-- 支付宝 -->
            <div class="payment-option" 
                 :class="{ 'selected': paymentMethod === '支付宝' }" 
                 @click="selectPaymentMethod('支付宝')"
                 style="cursor: pointer;">
                <div class="payment-icon alipay-icon">
                    <i class="fab fa-alipay"></i>
                </div>
                <div class="payment-text">支付宝</div>
                <div class="payment-check" v-if="paymentMethod === '支付宝'">
                    <i class="el-icon-check"></i>
                </div>
            </div>
            
            <!-- 现金 -->
            <div class="payment-option" 
                 :class="{ 'selected': paymentMethod === '现金' }" 
                 @click="selectPaymentMethod('现金')"
                 style="cursor: pointer;">
                <div class="payment-icon cash-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="payment-text">现金</div>
                <div class="payment-check" v-if="paymentMethod === '现金'">
                    <i class="el-icon-check"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 备注 - 靠左排列 -->
    <div class="summary-row" style="display: flex; align-items: flex-start;">
        <span style="font-weight: 500; color: #606266; margin-right: 15px; min-width: 70px; padding-top: 8px;">备注：</span>
        <el-input 
            v-model="remark" 
            type="textarea" 
            placeholder="可填写备注信息" 
            :rows="3"
            maxlength="200"
            show-word-limit
            style="flex: 1; max-width: 500px; text-align: left;">
        </el-input>
    </div>
    
    <!-- 总计金额 - 靠左 -->
    <div class="total-amount" style="text-align: left; margin-top: 20px;">
        总计金额：<span style="color: #f56c6c; font-size: 28px;">[[ totalAmount.toFixed(2) ]]</span> 元
    </div>
</div>
                        
                        <!-- 操作按钮 -->
                        <div class="action-buttons">
                            <el-button type="primary" size="large" @click="generateBill" :disabled="!canGenerate" :loading="generating">
                                <i class="el-icon-printer"></i> 收费并打印
                            </el-button>
                            <el-button type="info" size="large" @click="clearForm">
                                清空重填
                            </el-button>
                        </div>
                    </div>
                </div>
                
                <!-- 订单查询页面（暂未实现） -->
                <div v-if="currentPage === 'query'">
                    <div class="header">
                        <div class="header-title">订单查询</div>
                    </div>
                    <div class="workbench-container">
                        <div style="text-align: center; padding: 50px; color: #999;">
                            <i class="el-icon-search" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <p>订单查询功能正在开发中...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
{% raw %}
const { createApp, ref, computed, onMounted } = Vue;
const { ElSelect, ElOption, ElButton, ElInput, ElInputNumber, ElMessage, ElMessageBox } = ElementPlus;

// 创建Vue应用实例，并设置自定义分隔符
const app = createApp({
    compilerOptions: {
        delimiters: ['[[', ']]']
    },
    setup() {
        // 用户信息
        const user = ref(JSON.parse(localStorage.getItem('user')) || {});
        
        // 当前页面
        const currentPage = ref('workbench');
        
        // 工作台数据
        const buildings = ref([]);  // 楼栋列表
        const rooms = ref([]);      // 房间列表
        const selectedBuilding = ref('');
        const selectedRoomId = ref('');
        const feeItems = ref([]);
        const paymentMethod = ref('');
        const remark = ref('');
        const generating = ref(false);

        // 新增：住户信息
        const residentName = ref('');
        const residentPhone = ref('');
        const phoneError = ref('');




// 添加状态变量
const communityPrices = ref({});

// 添加方法：获取当前小区的收费标准
const loadCommunityPrices = async () => {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/fee_prices', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        if (result.status === 'success') {
            const priceMap = {};
            result.data.forEach(item => {
                priceMap[item.fee_type] = item.unit_price;
            });
            communityPrices.value = priceMap;
            console.log('小区单价加载成功: ', priceMap);
        } else {
            ElMessage.error('加载收费标准失败');
        }
    } catch (error) {
        console.error('获取单价配置失败:', error);
        ElMessage.error('网络请求失败');
    }
};

// 修改 addFeeItem 函数，优先使用小区配置单价
const addFeeItem = (type) => {
    if (addedFeeTypes.value.has(type)) {
        ElMessage.warning(`${getFeeTypeName(type)}已添加，不能重复添加`);
        return;
    }

    const config = feeConfig[type];
    if (!config) return;

    // 关键修改：优先使用 communityPrices 中的单价
    const unitPriceFromServer = communityPrices.value[type];
    const unitPriceToUse = unitPriceFromServer !== undefined ? unitPriceFromServer : config.defaultUnitPrice;

    const newItem = {
        type: type,
        quantity: 1,
        unitPrice: unitPriceToUse,
        amount: unitPriceToUse
    };

    if (type === 'parking') {
        newItem.carPlate = '';
    }

    feeItems.value.push(newItem);
    addedFeeTypes.value.add(type);
    ElMessage.success(`已添加${getFeeTypeName(type)}`);
};
























        // 费用类型配置
        const feeConfig = {
            electricity: { 
                name: '电费', 
                unit: '度', 
                defaultUnitPrice: 0.8,
                hasCarPlate: false 
            },
            coldWater: { 
                name: '冷水费', 
                unit: '吨', 
                defaultUnitPrice: 3.5,
                hasCarPlate: false 
            },
            hotWater: { 
                name: '热水费', 
                unit: '吨', 
                defaultUnitPrice: 25,
                hasCarPlate: false 
            },
            network: { 
                name: '网费', 
                unit: '月', 
                defaultUnitPrice: 60,
                hasCarPlate: false 
            },
            parking: { 
                name: '停车费', 
                unit: '月', 
                defaultUnitPrice: 200,
                hasCarPlate: true 
            }
        };
        
        // 已添加的费用类型集合
        const addedFeeTypes = ref(new Set());
        
        // 检查费用类型是否已添加
        const isFeeTypeAdded = (type) => {
            return addedFeeTypes.value.has(type);
        };
        
        // 获取费用类型名称
        const getFeeTypeName = (type) => {
            return feeConfig[type]?.name || type;
        };
        
        // 获取费用单位
        const getFeeUnit = (type) => {
            return feeConfig[type]?.unit || '';
        };
        
        // 计算总金额
        const totalAmount = computed(() => {
            return feeItems.value.reduce((sum, item) => {
                return sum + (parseFloat(item.amount) || 0);
            }, 0);
        });
        
        // 是否可以生成账单
        const canGenerate = computed(() => {
            return selectedRoomId.value && 
                   feeItems.value.length > 0 && 
                   paymentMethod.value && 
                   totalAmount.value > 0 &&
                   !phoneError.value;  // 手机号格式正确才允许提交
        });
        
        // 按钮禁用状态
        const buttonDisabled = computed(() => {
            return {
                electricity: isFeeTypeAdded('electricity'),
                coldWater: isFeeTypeAdded('coldWater'),
                hotWater: isFeeTypeAdded('hotWater'),
                network: isFeeTypeAdded('network'),
                parking: isFeeTypeAdded('parking')
            };
        });
        
        // 验证手机号
        const validatePhone = () => {
            const phone = residentPhone.value;
            if (phone && !/^1[3-9]\d{9}$/.test(phone)) {
                phoneError.value = '手机号格式不正确（11位数字，1开头）';
            } else {
                phoneError.value = '';
            }
        };
        
        // 楼栋改变事件
        const onBuildingChange = async (building) => {
            selectedBuilding.value = building;
            selectedRoomId.value = '';
            rooms.value = [];
            residentName.value = '';
            residentPhone.value = '';
            phoneError.value = '';
            
            if (building) {
                await loadRooms(building);
            }
        };
        
        // 加载房间列表
        const loadRooms = async (building) => {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/addresses?step=rooms&building=${encodeURIComponent(building)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    rooms.value = result.data;
                } else {
                    ElMessage.error('加载房间列表失败');
                }
            } catch (error) {
                console.error('加载房间列表失败:', error);
                ElMessage.error('网络请求失败');
            }
        };
        
        // 房间改变事件
        const onRoomChange = (roomId) => {
            selectedRoomId.value = roomId;
            
            // 查找选中的房间信息
            const room = rooms.value.find(r => r.id === roomId);
            if (room) {
                // 自动填充住户信息
                residentName.value = room.name || '';
                residentPhone.value = room.phone || '';
                validatePhone();
            }
        };
        
        // 添加费用项目
        const addFeeItem = (type) => {
            // 检查是否已添加
            if (addedFeeTypes.value.has(type)) {
                ElMessage.warning(`${getFeeTypeName(type)}已添加，不能重复添加`);
                return;
            }
            
            const config = feeConfig[type];
            if (!config) return;
            
            const newItem = {
                type: type,
                quantity: 1,
                unitPrice: config.defaultUnitPrice,
                amount: config.defaultUnitPrice
            };
            
            // 如果是停车费，添加车牌号字段
            if (type === 'parking') {
                newItem.carPlate = '';
            }
            
            feeItems.value.push(newItem);
            addedFeeTypes.value.add(type); // 记录已添加的类型
            
            ElMessage.success(`已添加${getFeeTypeName(type)}`);
        };
        
        // 更新项目金额
        const updateItemAmount = (index) => {
            const item = feeItems.value[index];
            const quantity = parseFloat(item.quantity) || 0;
            const unitPrice = parseFloat(item.unitPrice) || 0;
            item.amount = (quantity * unitPrice).toFixed(2);
        };
        
        // 移除费用项目
        const removeFeeItem = (index) => {
            const removedType = feeItems.value[index].type;
            feeItems.value.splice(index, 1);
            addedFeeTypes.value.delete(removedType); // 释放费用类型
            ElMessage.success(`${getFeeTypeName(removedType)}已删除`);
        };
        
        // 选择收款方式
        const selectPaymentMethod = (method) => {
            if (paymentMethod.value === method) {
                // 如果已经选中，再次点击则取消选择
                paymentMethod.value = '';
            } else {
                paymentMethod.value = method;
            }
        };
        
        // 生成账单
        const generateBill = async () => {
            if (!canGenerate.value) return;
            
            try {
                generating.value = true;
                
                // 准备数据
                const orderData = {
                    addressId: selectedRoomId.value,
                    paymentMethod: paymentMethod.value,
                    totalAmount: totalAmount.value,
                    remark: remark.value,
                    residentName: residentName.value,
                    residentPhone: residentPhone.value,
                    items: feeItems.value.map(item => {
                        const itemData = {
                            type: item.type,
                            quantity: parseFloat(item.quantity) || 0,
                            unitPrice: parseFloat(item.unitPrice) || 0,
                            amount: parseFloat(item.amount) || 0
                        };
                        
                        // 如果是停车费，添加车牌号
                        if (item.type === 'parking' && item.carPlate) {
                            itemData.carPlate = item.carPlate;
                        }
                        
                        return itemData;
                    })
                };
                
                // 调用后端API
                const token = localStorage.getItem('token');
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(orderData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    ElMessage.success('账单生成成功！');
                    
                    // 弹出打印窗口
                    window.print();
                    
                    // 清空表单（自动重置）
                    setTimeout(() => {
                        // 清空费用项目
                        feeItems.value = [];
                        addedFeeTypes.value.clear();
                        
                        // 重置支付方式和备注
                        paymentMethod.value = '';
                        remark.value = '';
                        
                        // 不清空地址和住户信息，方便连续开单
                        ElMessage.success('订单已保存，可以继续开单');
                    }, 1000);
                    
                } else {
                    ElMessage.error(result.message || '账单生成失败');
                }
            } catch (error) {
                console.error('生成账单失败:', error);
                ElMessage.error('网络请求失败');
            } finally {
                generating.value = false;
            }
        };
        
        // 清空表单
        const clearForm = () => {
            ElMessageBox.confirm('确定要清空当前表单吗？', '提示', {
                confirmButtonText: '确定',
                cancelButtonText: '取消',
                type: 'warning'
            }).then(() => {
                // 清空费用项目
                feeItems.value = [];
                addedFeeTypes.value.clear();
                
                // 重置支付方式和备注
                paymentMethod.value = '';
                remark.value = '';
                
                // 清空住户信息
                residentName.value = '';
                residentPhone.value = '';
                phoneError.value = '';
                
                // 清空地址选择
                selectedBuilding.value = '';
                selectedRoomId.value = '';
                rooms.value = [];
                
                ElMessage.success('表单已清空');
            }).catch(() => {
                // 用户取消
            });
        };
        
        // 退出登录
        const logout = () => {
            ElMessageBox.confirm('确定要退出登录吗？', '提示', {
                confirmButtonText: '确定',
                cancelButtonText: '取消',
                type: 'warning'
            }).then(() => {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login';
            }).catch(() => {
                // 用户取消
            });
        };
        
        // 加载楼栋列表
        const loadBuildings = async () => {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/addresses?step=buildings', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    buildings.value = result.data;
                } else {
                    ElMessage.error('加载楼栋列表失败');
                }
            } catch (error) {
                console.error('加载楼栋列表失败:', error);
                ElMessage.error('网络请求失败');
            }
        };
        
        // 页面加载时初始化
        onMounted(() => {
            // 检查登录状态
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            // 加载楼栋数据
            loadBuildings();
            await loadCommunityPrices(); // 新增：加载收费标准
        });
        
        return {
            user,
            currentPage,
            buildings,
            rooms,
            selectedBuilding,
            selectedRoomId,
            feeItems,
            paymentMethod,
            remark,
            generating,
            residentName,
            residentPhone,
            phoneError,
            totalAmount,
            canGenerate,
            buttonDisabled,
            selectPaymentMethod,
            getFeeTypeName,
            getFeeUnit,
            validatePhone,
            onBuildingChange,
            onRoomChange,
            addFeeItem,
            updateItemAmount,
            removeFeeItem,
            generateBill,
            clearForm,
            logout
        };
    }
});

// 使用ElementPlus并挂载应用
app.use(ElementPlus).mount('#app');
{% endraw %}
    </script>
</body>
</html>