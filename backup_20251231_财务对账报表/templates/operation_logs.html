<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>操作日志查询 - 物业收费管理系统</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    
    <script src="/static/lib/vue.global.js"></script>
    <script src="/static/lib/element-plus.full.js"></script>
    <link rel="stylesheet" href="/static/lib/element-plus.css">
    <script src="/static/lib/axios.min.js"></script>
    <script src="/static/lib/flatpickr/flatpickr.min.js"></script>
    <link rel="stylesheet" href="/static/lib/flatpickr/airbnb.css">
    <script src="/static/lib/flatpickr/zh.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .page-header {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-bottom: 2px solid #409EFF;
        }

        .page-title {
            font-size: 20px;
            font-weight: 600;
            color: #303133;
        }

        .filter-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-size: 14px;
            color: #606266;
            white-space: nowrap;
        }

        .datetime-input {
            width: 180px;
            height: 32px;
            padding: 0 10px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            font-size: 14px;
        }

        .datetime-input:focus {
            border-color: #409EFF;
            outline: none;
        }

        .table-container {
            background: white;
            padding: 20px;
        }

        .table-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e4e7ed;
        }

        .table-title {
            font-size: 16px;
            font-weight: 600;
            color: #303133;
        }

        .result-badge {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
        }

        .result-success {
            background: #f0f9ff;
            color: #67c23a;
        }

        .result-fail {
            background: #fef0f0;
            color: #f56c6c;
        }

        .result-error {
            background: #fdf6ec;
            color: #e6a23c;
        }

        .pagination-container {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-info {
            color: #909399;
            font-size: 13px;
        }

        .detail-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #ebeef5;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            width: 120px;
            font-weight: 600;
            color: #606266;
        }

        .detail-value {
            flex: 1;
            color: #303133;
            word-break: break-all;
        }

        .json-viewer {
            background: #f5f7fa;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 页面标题 -->
        <div class="page-header">
            <div class="page-title">操作日志查询</div>
        </div>

        <!-- 筛选条件 -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-item">
                    <span class="filter-label">起始时间：</span>
                    <input type="text" id="startDate" class="datetime-input" placeholder="选择起始时间" readonly>
                </div>
                <div class="filter-item">
                    <span class="filter-label">结束时间：</span>
                    <input type="text" id="endDate" class="datetime-input" placeholder="选择结束时间" readonly>
                </div>

                <div class="filter-item" v-if="!isCommunityDisabled">
                    <span class="filter-label">选择地区：</span>
                    <el-select 
                        v-model="filters.community" 
                        placeholder="全部地区"
                        clearable
                        size="small"
                        style="width: 180px;">
                        <el-option
                            v-for="community in communities"
                            :key="community"
                            :label="community"
                            :value="community">
                        </el-option>
                    </el-select>
                </div>

                <div class="filter-item">
                    <span class="filter-label">操作类型：</span>
                    <el-select 
                        v-model="filters.operationType" 
                        placeholder="全部类型"
                        clearable
                        size="small"
                        style="width: 120px;">
                        <el-option label="登录" value="登录"></el-option>
                        <el-option label="登出" value="登出"></el-option>
                        <el-option label="新增" value="新增"></el-option>
                        <el-option label="修改" value="修改"></el-option>
                        <el-option label="删除" value="删除"></el-option>
                        <el-option label="查询" value="查询"></el-option>
                        <el-option label="导出" value="导出"></el-option>
                        <el-option label="打印" value="打印"></el-option>
                        <el-option label="红冲" value="红冲"></el-option>
                    </el-select>
                </div>

                <div class="filter-item">
                    <span class="filter-label">操作模块：</span>
                    <el-select 
                        v-model="filters.operationModule" 
                        placeholder="全部模块"
                        clearable
                        size="small"
                        style="width: 150px;">
                        <el-option label="用户管理" value="用户管理"></el-option>
                        <el-option label="订单管理" value="订单管理"></el-option>
                        <el-option label="收费标准管理" value="收费标准管理"></el-option>
                        <el-option label="数据报表" value="数据报表"></el-option>
                        <el-option label="系统登录" value="系统登录"></el-option>
                    </el-select>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-item">
                    <span class="filter-label">用户账号：</span>
                    <el-input 
                        v-model="filters.username" 
                        placeholder="输入用户账号"
                        clearable
                        size="small"
                        style="width: 150px;">
                    </el-input>
                </div>

                <div class="filter-item">
                    <span class="filter-label">操作结果：</span>
                    <el-select 
                        v-model="filters.operationResult" 
                        placeholder="全部结果"
                        clearable
                        size="small"
                        style="width: 120px;">
                        <el-option label="成功" value="success"></el-option>
                        <el-option label="失败" value="fail"></el-option>
                        <el-option label="错误" value="error"></el-option>
                    </el-select>
                </div>

                <div class="filter-item" style="margin-left: auto;">
                    <el-button type="primary" size="small" @click="searchLogs" :loading="loading">
                        查询
                    </el-button>
                    <el-button size="small" @click="resetFilters">
                        重置
                    </el-button>
                    <el-button type="success" size="small" @click="exportLogs" :loading="exporting">
                        导出Excel
                    </el-button>
                </div>
            </div>
        </div>

        <!-- 数据表格 -->
        <div class="table-container">
            <div class="table-header">
                <div class="table-title">
                    操作日志列表
                    <span v-if="total > 0" style="color: #909399; font-size: 14px; margin-left: 10px;">
                        共 [[ total ]] 条记录
                    </span>
                </div>
            </div>

            <el-table 
                :data="logs" 
                v-loading="loading"
                stripe
                size="small"
                style="width: 100%">
                
                <el-table-column prop="operation_time" label="操作时间" width="160" sortable></el-table-column>
                <el-table-column prop="username" label="用户账号" width="110"></el-table-column>
                <el-table-column prop="real_name" label="姓名" width="90"></el-table-column>
                <el-table-column prop="community" label="所属小区" width="140"></el-table-column>
                <el-table-column prop="ip_address" label="IP地址" width="130"></el-table-column>
                <el-table-column prop="browser" label="浏览器" width="130"></el-table-column>
                <el-table-column prop="operation_type" label="操作类型" width="90"></el-table-column>
                <el-table-column prop="operation_module" label="操作模块" width="130"></el-table-column>
                
                <el-table-column prop="operation_result" label="结果" width="70">
                    <template #default="scope">
                        <span :class="getResultClass(scope.row.operation_result)" class="result-badge">
                            [[ getResultText(scope.row.operation_result) ]]
                        </span>
                    </template>
                </el-table-column>

                <el-table-column prop="response_time" label="响应(ms)" width="90">
                    <template #default="scope">
                        [[ scope.row.response_time ]]
                    </template>
                </el-table-column>

                <el-table-column label="操作" width="80" fixed="right">
                    <template #default="scope">
                        <el-button type="text" size="small" @click="showDetail(scope.row)">
                            详情
                        </el-button>
                    </template>
                </el-table-column>
            </el-table>

            <!-- 分页 -->
            <div class="pagination-container" v-if="total > 0">
                <div class="page-info">
                    显示 [[ (currentPage - 1) * pageSize + 1 ]] - [[ Math.min(currentPage * pageSize, total) ]] 条
                </div>
                <el-pagination
                    v-model:current-page="currentPage"
                    v-model:page-size="pageSize"
                    :page-sizes="[20, 50, 100, 200]"
                    :total="total"
                    layout="sizes, prev, pager, next"
                    small
                    @size-change="handleSizeChange"
                    @current-change="handlePageChange">
                </el-pagination>
            </div>
        </div>

        <!-- 详情弹窗 -->
        <el-dialog 
            v-model="detailDialogVisible" 
            title="操作日志详情" 
            width="800px">
            
            <div v-if="currentLog" style="max-height: 500px; overflow-y: auto;">
                <div class="detail-row">
                    <div class="detail-label">日志ID:</div>
                    <div class="detail-value">[[ currentLog.id ]]</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">操作时间:</div>
                    <div class="detail-value">[[ currentLog.operation_time ]]</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">用户信息:</div>
                    <div class="detail-value">
                        [[ currentLog.real_name ]] ([[ currentLog.username ]]) - [[ currentLog.user_role ]]
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">所属小区:</div>
                    <div class="detail-value">[[ currentLog.community || '-' ]]</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">IP地址:</div>
                    <div class="detail-value">[[ currentLog.ip_address ]]</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">MAC地址:</div>
                    <div class="detail-value">[[ currentLog.mac_address || '未获取' ]]</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">浏览器:</div>
                    <div class="detail-value">[[ currentLog.browser || '未知' ]]</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">操作类型:</div>
                    <div class="detail-value">[[ currentLog.operation_type ]]</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">操作模块:</div>
                    <div class="detail-value">[[ currentLog.operation_module ]]</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">操作结果:</div>
                    <div class="detail-value">
                        <span :class="getResultClass(currentLog.operation_result)" class="result-badge">
                            [[ getResultText(currentLog.operation_result) ]]
                        </span>
                    </div>
                </div>
                <div class="detail-row" v-if="currentLog.target_id">
                    <div class="detail-label">目标对象:</div>
                    <div class="detail-value">
                        [[ currentLog.target_type ]] (ID: [[ currentLog.target_id ]])
                    </div>
                </div>
                <div class="detail-row" v-if="currentLog.operation_detail">
                    <div class="detail-label">操作详情:</div>
                    <div class="detail-value">
                        <div class="json-viewer">[[ formatJson(currentLog.operation_detail) ]]</div>
                    </div>
                </div>
                <div class="detail-row" v-if="currentLog.error_message">
                    <div class="detail-label">错误信息:</div>
                    <div class="detail-value" style="color: #f56c6c;">
                        [[ currentLog.error_message ]]
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">请求方法:</div>
                    <div class="detail-value">[[ currentLog.request_method ]]</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">请求URL:</div>
                    <div class="detail-value" style="word-break: break-all; font-size: 12px;">
                        [[ currentLog.request_url ]]
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">响应时间:</div>
                    <div class="detail-value">[[ currentLog.response_time ]]ms</div>
                </div>
                <div class="detail-row" v-if="currentLog.user_agent">
                    <div class="detail-label">浏览器信息:</div>
                    <div class="detail-value" style="font-size: 12px; word-break: break-all;">
                        [[ currentLog.user_agent ]]
                    </div>
                </div>
            </div>

            <template #footer>
                <el-button size="small" @click="detailDialogVisible = false">关闭</el-button>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        const { ElMessage } = ElementPlus;

        createApp({
            compilerOptions: {
                delimiters: ['[[', ']]']
            },
            setup() {
                const loading = ref(false);
                const exporting = ref(false);
                const logs = ref([]);
                const total = ref(0);
                const currentPage = ref(1);
                const pageSize = ref(20);

                // 筛选条件
                const filters = ref({
                    community: '',
                    operationType: '',
                    operationModule: '',
                    username: '',
                    operationResult: ''
                });

                // 地区选择相关
                const communities = ref([]);
                const userInfo = ref({
                    role: '',
                    community: ''
                });

                const isCommunityDisabled = computed(() => {
                    return userInfo.value.role === '小区操作员';
                });

                // 详情弹窗
                const detailDialogVisible = ref(false);
                const currentLog = ref(null);

                // 获取Token
                const getToken = () => {
                    return sessionStorage.getItem('token');
                };

                // 获取用户信息
                const loadUserInfo = () => {
                    const userData = sessionStorage.getItem('user');
                    if (userData) {
                        const user = JSON.parse(userData);
                        userInfo.value = {
                            role: user.role,
                            community: user.community || ''
                        };
                        
                        if (user.role === '小区操作员' && user.community) {
                            filters.value.community = user.community;
                        }
                    }
                };

                // 加载小区列表
                const loadCommunities = async () => {
                    try {
                        const token = getToken();
                        const response = await axios.get('/api/communities', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.data.status === 'success') {
                            communities.value = response.data.communities;
                        }
                    } catch (error) {
                        console.error('加载小区列表失败:', error);
                    }
                };

                // 初始化日期选择器
                const initDatePickers = () => {
                    // 检查 flatpickr 是否已加载
                    if (typeof flatpickr === 'undefined') {
                        console.warn('flatpickr 未加载，等待加载...');
                        setTimeout(initDatePickers, 100);
                        return;
                    }
                    
                    const now = new Date();
                    const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    
                    flatpickr('#startDate', {
                        locale: 'zh',
                        dateFormat: 'Y-m-d',
                        defaultDate: thirtyDaysAgo,
                        maxDate: now
                    });
                    
                    flatpickr('#endDate', {
                        locale: 'zh',
                        dateFormat: 'Y-m-d',
                        defaultDate: now,
                        maxDate: now
                    });
                };

                // 查询日志
                const searchLogs = async () => {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    if (!startDate || !endDate) {
                        ElMessage.warning('请选择日期范围');
                        return;
                    }

                    loading.value = true;
                    
                    try {
                        const token = getToken();
                        const params = {
                            start_date: startDate,
                            end_date: endDate,
                            page: currentPage.value,
                            page_size: pageSize.value
                        };

                        // 添加筛选条件
                        if (filters.value.community) params.community = filters.value.community;
                        if (filters.value.operationType) params.operation_type = filters.value.operationType;
                        if (filters.value.operationModule) params.operation_module = filters.value.operationModule;
                        if (filters.value.username) params.username = filters.value.username;
                        if (filters.value.operationResult) params.operation_result = filters.value.operationResult;

                        const response = await axios.get('/api/operation-logs', {
                            params,
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (response.data.status === 'success') {
                            logs.value = response.data.data;
                            total.value = response.data.total;
                            ElMessage.success(`查询成功，共${total.value}条记录`);
                        } else {
                            ElMessage.error(response.data.message || '查询失败');
                        }
                    } catch (error) {
                        console.error('查询失败:', error);
                        ElMessage.error('查询失败，请重试');
                    } finally {
                        loading.value = false;
                    }
                };

                // 重置筛选条件
                const resetFilters = () => {
                    filters.value = {
                        community: userInfo.value.role === '小区操作员' ? userInfo.value.community : '',
                        operationType: '',
                        operationModule: '',
                        username: '',
                        operationResult: ''
                    };
                    currentPage.value = 1;
                };

                // 导出Excel
                const exportLogs = async () => {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;

                    if (!startDate || !endDate) {
                        ElMessage.warning('请选择日期范围');
                        return;
                    }

                    exporting.value = true;
                    
                    try {
                        const token = getToken();
                        const params = new URLSearchParams({
                            start_date: startDate,
                            end_date: endDate
                        });

                        if (filters.value.community) params.append('community', filters.value.community);
                        if (filters.value.operationType) params.append('operation_type', filters.value.operationType);
                        if (filters.value.operationModule) params.append('operation_module', filters.value.operationModule);
                        if (filters.value.username) params.append('username', filters.value.username);
                        if (filters.value.operationResult) params.append('operation_result', filters.value.operationResult);

                        const response = await axios.get(`/api/operation-logs/export?${params.toString()}`, {
                            headers: { 'Authorization': `Bearer ${token}` },
                            responseType: 'blob'
                        });

                        const url = window.URL.createObjectURL(new Blob([response.data]));
                        const link = document.createElement('a');
                        link.href = url;
                        link.setAttribute('download', `操作日志_${startDate}_${endDate}.xlsx`);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        ElMessage.success('导出成功');
                    } catch (error) {
                        console.error('导出失败:', error);
                        ElMessage.error('导出失败，请重试');
                    } finally {
                        exporting.value = false;
                    }
                };

                // 显示详情
                const showDetail = (row) => {
                    currentLog.value = row;
                    detailDialogVisible.value = true;
                };

                // 分页处理
                const handlePageChange = (page) => {
                    currentPage.value = page;
                    searchLogs();
                };

                const handleSizeChange = (size) => {
                    pageSize.value = size;
                    currentPage.value = 1;
                    searchLogs();
                };

                // 获取结果样式类
                const getResultClass = (result) => {
                    if (result === 'success') return 'result-success';
                    if (result === 'fail') return 'result-fail';
                    if (result === 'error') return 'result-error';
                    return '';
                };

                // 获取结果文本
                const getResultText = (result) => {
                    if (result === 'success') return '成功';
                    if (result === 'fail') return '失败';
                    if (result === 'error') return '错误';
                    return result;
                };

                // 格式化JSON
                const formatJson = (str) => {
                    try {
                        const obj = JSON.parse(str);
                        return JSON.stringify(obj, null, 2);
                    } catch {
                        return str;
                    }
                };

                onMounted(() => {
                    loadUserInfo();
                    loadCommunities();
                    initDatePickers();
                });

                return {
                    loading,
                    exporting,
                    logs,
                    total,
                    currentPage,
                    pageSize,
                    filters,
                    communities,
                    isCommunityDisabled,
                    detailDialogVisible,
                    currentLog,
                    searchLogs,
                    resetFilters,
                    exportLogs,
                    showDetail,
                    handlePageChange,
                    handleSizeChange,
                    getResultClass,
                    getResultText,
                    formatJson
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
